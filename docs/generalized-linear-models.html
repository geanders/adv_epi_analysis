<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 4 Generalized linear models | Advanced Epidemiological Analysis</title>
  <meta name="description" content="This is the coursebook for the Colorado State University course ERHS 732, Advanced Epidemiological Analysis." />
  <meta name="generator" content="bookdown 0.21 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 4 Generalized linear models | Advanced Epidemiological Analysis" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is the coursebook for the Colorado State University course ERHS 732, Advanced Epidemiological Analysis." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 4 Generalized linear models | Advanced Epidemiological Analysis" />
  
  <meta name="twitter:description" content="This is the coursebook for the Colorado State University course ERHS 732, Advanced Epidemiological Analysis." />
  

<meta name="author" content="Andreas M. Neophytou and G. Brooke Anderson" />


<meta name="date" content="2021-09-22" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="time-series-case-crossover-studies.html"/>
<link rel="next" href="natural-experiments.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>
<link href="libs/anchor-sections-1.0/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0/anchor-sections.js"></script>


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Advanced Epidemiological Analysis</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Overview</a><ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#license"><i class="fa fa-check"></i><b>1.1</b> License</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="courseinfo.html"><a href="courseinfo.html"><i class="fa fa-check"></i><b>2</b> Course information</a><ul>
<li class="chapter" data-level="2.1" data-path="courseinfo.html"><a href="courseinfo.html#course-learning-objectives"><i class="fa fa-check"></i><b>2.1</b> Course learning objectives</a></li>
<li class="chapter" data-level="2.2" data-path="courseinfo.html"><a href="courseinfo.html#meeting-time-and-place"><i class="fa fa-check"></i><b>2.2</b> Meeting time and place</a></li>
<li class="chapter" data-level="2.3" data-path="courseinfo.html"><a href="courseinfo.html#class-structure-and-expectations"><i class="fa fa-check"></i><b>2.3</b> Class Structure and Expectations</a></li>
<li class="chapter" data-level="2.4" data-path="courseinfo.html"><a href="courseinfo.html#course-grading"><i class="fa fa-check"></i><b>2.4</b> Course grading</a></li>
<li class="chapter" data-level="2.5" data-path="courseinfo.html"><a href="courseinfo.html#course-schedule"><i class="fa fa-check"></i><b>2.5</b> Course Schedule</a></li>
<li class="chapter" data-level="2.6" data-path="courseinfo.html"><a href="courseinfo.html#textbooks-and-course-materials"><i class="fa fa-check"></i><b>2.6</b> Textbooks and Course Materials</a></li>
<li class="chapter" data-level="2.7" data-path="courseinfo.html"><a href="courseinfo.html#prerequisites-and-preparation"><i class="fa fa-check"></i><b>2.7</b> Prerequisites and Preparation</a></li>
<li class="chapter" data-level="2.8" data-path="courseinfo.html"><a href="courseinfo.html#academic-honesty"><i class="fa fa-check"></i><b>2.8</b> Academic Honesty</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="time-series-case-crossover-studies.html"><a href="time-series-case-crossover-studies.html"><i class="fa fa-check"></i><b>3</b> Time series / case-crossover studies</a><ul>
<li class="chapter" data-level="3.1" data-path="time-series-case-crossover-studies.html"><a href="time-series-case-crossover-studies.html#readings"><i class="fa fa-check"></i><b>3.1</b> Readings</a></li>
<li class="chapter" data-level="3.2" data-path="time-series-case-crossover-studies.html"><a href="time-series-case-crossover-studies.html#time-series-and-case-crossover-study-designs"><i class="fa fa-check"></i><b>3.2</b> Time series and case-crossover study designs</a></li>
<li class="chapter" data-level="3.3" data-path="time-series-case-crossover-studies.html"><a href="time-series-case-crossover-studies.html#time-series-data"><i class="fa fa-check"></i><b>3.3</b> Time series data</a></li>
<li class="chapter" data-level="3.4" data-path="time-series-case-crossover-studies.html"><a href="time-series-case-crossover-studies.html#exploratory-data-analysis"><i class="fa fa-check"></i><b>3.4</b> Exploratory data analysis</a></li>
<li class="chapter" data-level="3.5" data-path="time-series-case-crossover-studies.html"><a href="time-series-case-crossover-studies.html#statistical-modeling-for-a-time-series-study"><i class="fa fa-check"></i><b>3.5</b> Statistical modeling for a time series study</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="generalized-linear-models.html"><a href="generalized-linear-models.html"><i class="fa fa-check"></i><b>4</b> Generalized linear models</a><ul>
<li class="chapter" data-level="4.1" data-path="generalized-linear-models.html"><a href="generalized-linear-models.html#readings-1"><i class="fa fa-check"></i><b>4.1</b> Readings</a></li>
<li class="chapter" data-level="4.2" data-path="generalized-linear-models.html"><a href="generalized-linear-models.html#splines-in-glms"><i class="fa fa-check"></i><b>4.2</b> Splines in GLMs</a></li>
<li class="chapter" data-level="4.3" data-path="generalized-linear-models.html"><a href="generalized-linear-models.html#distributed-lags-and-cross-basis-functions-in-glms"><i class="fa fa-check"></i><b>4.3</b> Distributed lags and cross-basis functions in GLMs</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="natural-experiments.html"><a href="natural-experiments.html"><i class="fa fa-check"></i><b>5</b> Natural experiments</a><ul>
<li class="chapter" data-level="5.1" data-path="natural-experiments.html"><a href="natural-experiments.html#readings-2"><i class="fa fa-check"></i><b>5.1</b> Readings</a></li>
<li class="chapter" data-level="5.2" data-path="natural-experiments.html"><a href="natural-experiments.html#natural-experiments-1"><i class="fa fa-check"></i><b>5.2</b> Natural experiments</a></li>
<li class="chapter" data-level="5.3" data-path="natural-experiments.html"><a href="natural-experiments.html#interrupted-time-series"><i class="fa fa-check"></i><b>5.3</b> Interrupted time series</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="risk-assessment.html"><a href="risk-assessment.html"><i class="fa fa-check"></i><b>6</b> Risk assessment</a></li>
<li class="chapter" data-level="7" data-path="longitudinal-cohort-study-designs.html"><a href="longitudinal-cohort-study-designs.html"><i class="fa fa-check"></i><b>7</b> Longitudinal cohort study designs</a><ul>
<li class="chapter" data-level="7.1" data-path="longitudinal-cohort-study-designs.html"><a href="longitudinal-cohort-study-designs.html#longitudinal-cohort-data"><i class="fa fa-check"></i><b>7.1</b> Longitudinal cohort data</a></li>
<li class="chapter" data-level="7.2" data-path="longitudinal-cohort-study-designs.html"><a href="longitudinal-cohort-study-designs.html#coding-a-survival-analysis"><i class="fa fa-check"></i><b>7.2</b> Coding a survival analysis</a></li>
<li class="chapter" data-level="7.3" data-path="longitudinal-cohort-study-designs.html"><a href="longitudinal-cohort-study-designs.html#handling-complexity"><i class="fa fa-check"></i><b>7.3</b> Handling complexity</a><ul>
<li class="chapter" data-level="7.3.1" data-path="longitudinal-cohort-study-designs.html"><a href="longitudinal-cohort-study-designs.html#multi-level-exposure"><i class="fa fa-check"></i><b>7.3.1</b> Multi-level exposure</a></li>
<li class="chapter" data-level="7.3.2" data-path="longitudinal-cohort-study-designs.html"><a href="longitudinal-cohort-study-designs.html#recurrent-outcome"><i class="fa fa-check"></i><b>7.3.2</b> Recurrent outcome</a></li>
<li class="chapter" data-level="7.3.3" data-path="longitudinal-cohort-study-designs.html"><a href="longitudinal-cohort-study-designs.html#time-varying-coeffificents"><i class="fa fa-check"></i><b>7.3.3</b> Time-varying coeffificents</a></li>
<li class="chapter" data-level="7.3.4" data-path="longitudinal-cohort-study-designs.html"><a href="longitudinal-cohort-study-designs.html#using-survey-results"><i class="fa fa-check"></i><b>7.3.4</b> Using survey results</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="some-approaches-for-confounding.html"><a href="some-approaches-for-confounding.html"><i class="fa fa-check"></i><b>8</b> Some approaches for confounding</a><ul>
<li class="chapter" data-level="8.1" data-path="some-approaches-for-confounding.html"><a href="some-approaches-for-confounding.html#inverse-probability-weighting"><i class="fa fa-check"></i><b>8.1</b> Inverse probability weighting</a></li>
<li class="chapter" data-level="8.2" data-path="some-approaches-for-confounding.html"><a href="some-approaches-for-confounding.html#propensity-scores"><i class="fa fa-check"></i><b>8.2</b> Propensity scores</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="mixed-models.html"><a href="mixed-models.html"><i class="fa fa-check"></i><b>9</b> Mixed models</a></li>
<li class="chapter" data-level="10" data-path="instrumental-variables.html"><a href="instrumental-variables.html"><i class="fa fa-check"></i><b>10</b> Instrumental variables</a></li>
<li class="chapter" data-level="11" data-path="causal-inference.html"><a href="causal-inference.html"><i class="fa fa-check"></i><b>11</b> Causal inference</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Advanced Epidemiological Analysis</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="generalized-linear-models" class="section level1">
<h1><span class="header-section-number">Chapter 4</span> Generalized linear models</h1>
<div id="readings-1" class="section level2">
<h2><span class="header-section-number">4.1</span> Readings</h2>
<p>The readings for this chapter are:</p>
<ul>
<li><span class="citation">Bhaskaran et al. (<a href="#ref-bhaskaran2013time" role="doc-biblioref">2013</a>)</span> Provides an overview of time series regression
in environmental epidemiology.</li>
<li><span class="citation">Vicedo-Cabrera, Sera, and Gasparrini (<a href="#ref-vicedo2019hands" role="doc-biblioref">2019</a>)</span> Provides a tutorial of all the steps for a
projecting of health impacts of temperature extremes under climate change.
One of the steps is to fit the exposure-response association using present-day data
(the section on “Estimation of Exposure-Response Associations” in the paper).
In this chapter, we will go into details on that step, and that section of the paper
is the only required reading for this chapter. Later in the class, we’ll
look at other steps covered in this paper. Supplemental material for this paper is
available to download by
clicking <a href="http://links.lww.com/EDE/B504" class="uri">http://links.lww.com/EDE/B504</a>. You will need the data in this supplement
for the exercises for class.</li>
<li><span class="citation">Armstrong, Gasparrini, and Tobias (<a href="#ref-armstrong2014conditional" role="doc-biblioref">2014</a>)</span> This paper describes different data structures for
case-crossover data, as well as how conditional Poisson regression can be used
in some cases to fit a statistical model to these data.
Supplemental material for this paper is available at
<a href="https://bmcmedresmethodol.biomedcentral.com/articles/10.1186/1471-2288-14-122#Sec13" class="uri">https://bmcmedresmethodol.biomedcentral.com/articles/10.1186/1471-2288-14-122#Sec13</a>.</li>
</ul>
<p>The following are supplemental readings (i.e., not required, but may be of
interest) associated with the material in this chapter:</p>
<ul>
<li><span class="citation">Armstrong (<a href="#ref-armstrong2006models" role="doc-biblioref">2006</a>)</span> Covers similar material as <span class="citation">Bhaskaran et al. (<a href="#ref-bhaskaran2013time" role="doc-biblioref">2013</a>)</span>, but with
more focus on the statistical modeling framework (highly recommended!)</li>
<li><span class="citation">Gasparrini and Armstrong (<a href="#ref-gasparrini2010time" role="doc-biblioref">2010</a>)</span> Describes some of the advances made to time series study
designs and statistical analysis, specifically in the context of temperature</li>
<li><span class="citation">Basu, Dominici, and Samet (<a href="#ref-basu2005temperature" role="doc-biblioref">2005</a>)</span> Compares time series and case-crossover study designs in
the context of exploring temperature and health. Includes a nice illustration
of different referent periods, including time-stratified.</li>
<li><span class="citation">Imai et al. (<a href="#ref-imai2015time" role="doc-biblioref">2015</a>)</span> Typically, the time series study design covered in this
chapter is used to study non-communicable health outcomes. This paper discusses
opportunities and limitations in applying a similar framework for infectious
disease.</li>
<li><span class="citation">Lu and Zeger (<a href="#ref-lu2007equivalence" role="doc-biblioref">2007</a>)</span> Heavier on statistics. This paper shows how, under
conditions often common for environmental epidemiology studies, case-crossover
and time series methods are equivalent.</li>
<li><span class="citation">Gasparrini (<a href="#ref-gasparrini2014modeling" role="doc-biblioref">2014</a>)</span> Heavier on statistics. This provides the statistical
framework for the distributed lag model for environmental epidemiology time
series studies.</li>
<li><span class="citation">Dunn and Smyth (<a href="#ref-dunn2018generalized1" role="doc-biblioref">2018</a>)</span> Introduction to statistical models, moving into regression models and
generalized linear models. Chapter in a book that is available online through the CSU library.</li>
<li><span class="citation">James et al. (<a href="#ref-james2013introduction3" role="doc-biblioref">2013</a>)</span> General overview of linear regression, with an R coding
“lab” at the end to provide coding examples. Covers model fit, continuous, binary,
and categorical covariates, and interaction terms. Chapter in a book that is
available online through the CSU library.</li>
</ul>
</div>
<div id="splines-in-glms" class="section level2">
<h2><span class="header-section-number">4.2</span> Splines in GLMs</h2>
<p>We saw from the last model, with a linear term for mean daily temperature, that the
suggested effect on mortality is a decrease in daily mortality counts with
increasing temperature. However, as you’ve probably guessed that’s likely not
entirely accurate. A linear term for the effect of exposure restricts us to an
effect that can be fitted with a straight line (either a null effect or a
monotonically increasing or decreasing effect with increasing exposure).</p>
<p>This clearly is problematic in some cases. One example is when exploring the
association between temperature and health risk. Based on human physiology,
we would expect many health risks to be elevated at temperature extremes,
whether those are extreme cold or extreme heat. A linear term would be
inadequate to describe this kind of U-shaped association. Other effects might
have a threshold—for example, heat stroke might have a very low risk at
most temperatures, only increasing with temperature above a certain threshold.</p>
<p>We can
capture non-linear patterns in effects, by using different functions of X.
Examples are <span class="math inline">\(\sqrt{X}\)</span>, <span class="math inline">\(X^{2}\)</span>, or more complex smoothing functions, such as
polynomials or splines. Polynomials might at first make a lot of sense,
especially since you’ve likely come across polynomial terms in mathematics
classes since grade school. However, it turns out that they have some undesirable
properties. A key one is that they can have extreme behavior, particularly
when using a high-order polynomial, and particularly outside the range of
data that are available to fit the model.</p>
<p>An alternative that is generally preferred for environmental epidemiology
studies is the regression spline. The word “spline” originally comes from
drafting and engineering (ship building, in particular), where it described
a flexible piece of wood or metal that you could use to draw a curved line—it created
a curve that was flexible enough—but just flexible enough—to fit a space
(see Wikipedia’s very interesting article on <a href="https://en.wikipedia.org/wiki/Flat_spline">flat splines</a> for more).</p>
<p>Splines follow a similar idea in mathematics, making them helpful tools when
a line won’t fit your data well. In general, a spline fits together a few
simpler functions to create something with a curve or non-linearity. Each
simpler function operates within an interval of the data, and then they join
together at “knots” along the range of the data.
Regression splines are therefore simple parametric smoothing function,
which fit separate polynomial in each interval of the range of the predictor; these
can be linear, quadratic, and cubic.</p>
<p>The simplest example is a linear spline (also called a piecewise linear function).
This type of spline creates non-linearity by having
a breakpoint at the knot, allowing the slope of the line to be different in
the intervals of data on either side of the knot. The following plot shows an
example. Say you want to explore how mean temperature varies by the day in the
year (Jan 1 = 1, Jan 2 = 2, and so on) in the London example dataset from the
last chapter. Temperature tends to increase with day of
year for a while, but then it changes around the start of August, after that
decreasing with day of year. This patterns means that a line will give a bad fit
for how temperature changes with day of year, since it smooths right through that
change. On the other hand, you can get a very reasonable fit using a linear spline
with a knot around August 1 (day 213 in the year). These two examples are shown in
the following plot, with the linear function fit on the left and the linear spline
on the right:</p>
<p><img src="adv_epi_analysis_files/figure-html/unnamed-chunk-42-1.png" width="672" /></p>
<p>If you were to write out these regression models in mathematical notation, the
linear one is very simple:</p>
<p><span class="math display">\[
Y_t = \alpha + \beta X_t
\]</span>
where <span class="math inline">\(Y_t\)</span> is the temperature on day <span class="math inline">\(t\)</span>, <span class="math inline">\(\alpha\)</span> is the model intercept,
<span class="math inline">\(X_t\)</span> is the day of the year on day <span class="math inline">\(t\)</span>, and <span class="math inline">\(\beta\)</span> is the estimated coefficient
for <span class="math inline">\(X_t\)</span>.</p>
<p>The notation for the model with the linear spline is a bit more complex:</p>
<p><span class="math display">\[
Y_t = \alpha + \beta_1 X_t + \beta_2 (X_t - k)_+
\]</span></p>
<p>Here, <span class="math inline">\(Y_t\)</span> is again the temperature on day <span class="math inline">\(t\)</span>, <span class="math inline">\(X_t\)</span> is again the day of the year
on day <span class="math inline">\(t\)</span>, and <span class="math inline">\(\alpha\)</span> is again the intercept. The term <span class="math inline">\(k\)</span> is the “knot”—the
value of <span class="math inline">\(X\)</span> where we’re letting the slope change. In this example, we’re using
<span class="math inline">\(k = 213\)</span>. The term <span class="math inline">\((X_t - k)_+\)</span> has a special meaning—it takes the value
0 if <span class="math inline">\(X_t\)</span> is in the interval to the left of the knot, while if <span class="math inline">\(X_t\)</span> is in the
interval to the right of the knot, it takes the value of <span class="math inline">\(X_t\)</span> minus the knot
value:</p>
<p><span class="math display">\[ 
(X_t - k)_+ =
\begin{cases}
0, &amp; \mbox{if } X_t &lt; k \\
X_t - k, &amp; \mbox{if } X_t \ge k 
\end{cases}
\]</span></p>
<p>In this model, the coefficient <span class="math inline">\(\beta_1\)</span> estimates the slope of the line to the
left of the knot, while <span class="math inline">\(\beta_2\)</span> estimates how that slope will change to the
right of the knot.</p>
<p>Fortunately, we usually won’t have to get this complex in the model notation,
especially when we use more complex splines (where the notation would get even
more complex). Instead, we’ll often write out the
regression equation in a simpler way, just indicating that we’re using a function
of the covariate, rather than the covariate directly:</p>
<p><span class="math display">\[
Y_t = \alpha + f(X_t | \mathbf{\beta})
\]</span></p>
<p>where we can note that <span class="math inline">\(f(X_t)\)</span> is a function of day of the year (<span class="math inline">\(X_t\)</span>), fit in
this case using a linear spline, and with a set of estimated coefficients <span class="math inline">\(\mathbf{\beta}\)</span> for that
function (see <span class="citation">Armstrong (<a href="#ref-armstrong2006models" role="doc-biblioref">2006</a>)</span> for an example of using this model notation).</p>
<p>While a linear spline is the simplest conceptually (and mathematically), it often
isn’t very satisfying, because it fits a function with a sharp breakpoint, which
often isn’t realistic. For example, the linear spline fit above suggests that the
relationship between day of the year and temperature changes abruptly and dramatically
on August 1 of the year. In reality, we know that this change in the relationship
between day of year and temperature is probably a lot smoother.</p>
<p>To fit smoother shapes, we can move to higher level splines. Cubic splines
(“cubic” because they include terms of the covariate up to the third power) are
very popular.
An example of a cubic spline
function is <span class="math inline">\(X+X^{2}+X^{3}+I((X&gt;X_{0})*(X-X_{0})^3)\)</span>. This particular function is
a cubic spline with four degrees of freedom (<span class="math inline">\(df=4\)</span>) and one knot (<span class="math inline">\(X_{0}\)</span>).
A special type of cubic spline called a natural cubic spline is particularly popular.
Unlike a polynomial function, a natural cubic spline “behaves” better outside
the range of the data used to fit the model—they are constrained to continue
on a linear trajectory once they pass beyond the range of the data.</p>
<p>Regression splines can be fit in a GLM via the package <code>splines</code>. Two commonly
used examples of regression splines are b-splines and natural cubic
splines. <span class="citation">Vicedo-Cabrera, Sera, and Gasparrini (<a href="#ref-vicedo2019hands" role="doc-biblioref">2019</a>)</span> uses natural cubic splines, which can be fit with the
<code>ns</code> (for “natural spline”) function from the <code>splines</code> package.</p>
<p>While splines are great for fitting non-linear relationships, they do create some
challenges in interpreting the results. When you fit a linear relationship for
a covariate, you will get a single estimate that helps describe the fitted relationship
between that covariate and the outcome variable. However, when you use a non-linear
function, you’ll end up with a mix of coefficients associated with that function.
Sometimes, you will use splines to control for a potential confounder (as we
will in the exercises for this first part of the chapter). In this case, you don’t
need to worry about interpreting the estimated coefficients—you’re just trying to
control for the variable, rather than inferring anything about how it’s associated
with the outcome.
In later parts of this chapter, we’ll talk about how to interpret these coefficients
if you’re using a spline for the exposure that you’re interested in, when we talk
more broadly about basis functions.</p>
<p><em>Applied: Including a spline in a GLM</em></p>
<p>For this exercise, you will continue to build up the model that you began in
the examples in the previous chapter. The example uses the data provided with
one of this chapter’s readings, <span class="citation">Vicedo-Cabrera, Sera, and Gasparrini (<a href="#ref-vicedo2019hands" role="doc-biblioref">2019</a>)</span>.</p>
<ol style="list-style-type: decimal">
<li>Start by fitting a somewhat simple model—how are daily mortality counts
associated with (a) a linear and (b) a non-linear function of time? Is a linear
term appropriate to describe this association? What types of patterns are
captured by a non-linear function that are missed by a linear function?</li>
<li>In the last chapter, the final version of the model used a GLM with an
overdispersed Poisson distribution, including control for day of week.
Start from this model and add control for long-term and seasonal trends
over the study period.</li>
<li>Refine your model to fit for a non-linear, rather than linear, function
of temperature in the model. Does a non-linear term seem to be more
appropriate than a linear term?</li>
</ol>
<p><em>Applied exercise: Example code</em></p>
<ol style="list-style-type: decimal">
<li><strong>Start by fitting a somewhat simple model—how are daily mortality counts
associated with (a) a linear and (b) a non-linear function of time?</strong></li>
</ol>
<p>It is helpful to start by loading the R packages you are likely to need, as
well as the example dataset. You may also need to re-load the example data
and perform the steps taken to clean it in the last chapter:</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb74-1"><a href="generalized-linear-models.html#cb74-1"></a><span class="co"># Load some packages that will likely be useful</span></span>
<span id="cb74-2"><a href="generalized-linear-models.html#cb74-2"></a><span class="kw">library</span>(tidyverse)</span>
<span id="cb74-3"><a href="generalized-linear-models.html#cb74-3"></a><span class="kw">library</span>(viridis)</span>
<span id="cb74-4"><a href="generalized-linear-models.html#cb74-4"></a><span class="kw">library</span>(lubridate)</span>
<span id="cb74-5"><a href="generalized-linear-models.html#cb74-5"></a><span class="kw">library</span>(broom)</span>
<span id="cb74-6"><a href="generalized-linear-models.html#cb74-6"></a></span>
<span id="cb74-7"><a href="generalized-linear-models.html#cb74-7"></a><span class="co"># Load and clean the data</span></span>
<span id="cb74-8"><a href="generalized-linear-models.html#cb74-8"></a>obs &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;data/lndn_obs.csv&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb74-9"><a href="generalized-linear-models.html#cb74-9"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">dow =</span> <span class="kw">wday</span>(date, <span class="dt">label =</span> <span class="ot">TRUE</span>))</span></code></pre></div>
<p>For this first question, the aim is to model the association between time and
daily mortality counts within the example data. This approach is often used
to explore and, if needed, adjust for temporal factors in the data.</p>
<p>There are a number of factors that can act over time to create patterns in both
environmental exposures and health outcomes. For example, there may be changes
in air pollution exposures over the years of a study because of changes in
regulations or growth or decline of factories and automobile traffic in an area.
Changes in health care and in population demographics can cause patterns in
health outcomes over the study period. At a shorter, seasonal term, there are
also factors that could influence both exposures and outcomes, including
seasonal changes in climate, seasonal changes in emissions, and seasonal
patterns in health outcomes.</p>
<p>It can be difficult to pinpoint and measure these temporal factors, and so
instead a common practice is to include model control based on the time in the
study. This can be measured, for example, as the day since the start of the
study period.</p>
<p>You can easily add a column for day in study for a dataset that
includes date. R saves dates in a special format, which we’re using the in
<code>obs</code> dataset:</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="generalized-linear-models.html#cb75-1"></a><span class="kw">class</span>(obs<span class="op">$</span>date)</span></code></pre></div>
<pre><code>## [1] &quot;Date&quot;</code></pre>
<p>However, this is just a fancy overlay on a value that’s ultimately saved as
a number. Like most Unix programs, the date is saved as the number of days
since the Unix “epoch”, January 1, 1970. You can take advantage of this
convention—if you use <code>as.numeric</code> around a date in R, it will give you a
number that gets one unit higher for every new date. Here’s the example for
the first date in our example data:</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="generalized-linear-models.html#cb77-1"></a>obs<span class="op">$</span>date[<span class="dv">1</span>]</span></code></pre></div>
<pre><code>## [1] &quot;1990-01-01&quot;</code></pre>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="generalized-linear-models.html#cb79-1"></a><span class="kw">as.numeric</span>(obs<span class="op">$</span>date[<span class="dv">1</span>]) </span></code></pre></div>
<pre><code>## [1] 7305</code></pre>
<p>And here’s the example for the next date:</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="generalized-linear-models.html#cb81-1"></a>obs<span class="op">$</span>date[<span class="dv">2</span>]</span></code></pre></div>
<pre><code>## [1] &quot;1990-01-02&quot;</code></pre>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb83-1"><a href="generalized-linear-models.html#cb83-1"></a><span class="kw">as.numeric</span>(obs<span class="op">$</span>date[<span class="dv">2</span>])</span></code></pre></div>
<pre><code>## [1] 7306</code></pre>
<p>You can use this convention to add a column that gives days since the first
study date. While you could also use the <code>1:n()</code> call to get a number for
each row that goes from 1 to the number of rows, that approach would not
catch any “skips” in dates in the data (e.g., missing dates if only warm-season
data are included). The use of the dates is more robust:</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="generalized-linear-models.html#cb85-1"></a>obs &lt;-<span class="st"> </span>obs <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb85-2"><a href="generalized-linear-models.html#cb85-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">time =</span> <span class="kw">as.numeric</span>(date) <span class="op">-</span><span class="st"> </span><span class="kw">first</span>(<span class="kw">as.numeric</span>(date)))</span>
<span id="cb85-3"><a href="generalized-linear-models.html#cb85-3"></a></span>
<span id="cb85-4"><a href="generalized-linear-models.html#cb85-4"></a>obs <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb85-5"><a href="generalized-linear-models.html#cb85-5"></a><span class="st">  </span><span class="kw">select</span>(date, time)</span></code></pre></div>
<pre><code>## # A tibble: 8,279 x 2
##    date        time
##    &lt;date&gt;     &lt;dbl&gt;
##  1 1990-01-01     0
##  2 1990-01-02     1
##  3 1990-01-03     2
##  4 1990-01-04     3
##  5 1990-01-05     4
##  6 1990-01-06     5
##  7 1990-01-07     6
##  8 1990-01-08     7
##  9 1990-01-09     8
## 10 1990-01-10     9
## # … with 8,269 more rows</code></pre>
<p>As a next step, it is always useful to use exploratory data analysis to look
at the patterns that might exist for an association, before you start designing
and fitting the regression model.</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="generalized-linear-models.html#cb87-1"></a><span class="kw">ggplot</span>(obs, </span>
<span id="cb87-2"><a href="generalized-linear-models.html#cb87-2"></a>       <span class="kw">aes</span>(<span class="dt">x =</span> time, <span class="dt">y =</span> all)) <span class="op">+</span></span>
<span id="cb87-3"><a href="generalized-linear-models.html#cb87-3"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">size =</span> <span class="fl">0.5</span>, <span class="dt">alpha =</span> <span class="fl">0.5</span>)</span></code></pre></div>
<p><img src="adv_epi_analysis_files/figure-html/unnamed-chunk-48-1.png" width="672" /></p>
<p>There are clear patterns between time and daily mortality counts in these data.
First, there is a clear long-term pattern, with mortality rates declining on
average over time. Second, there are clear seasonal patterns, with higher
mortality generally in the winter and lower rates in the summer.</p>
<p>To model this, we can start with fitting a linear term. In the last chapter,
we determined that the mortality outcome data can be fit using a GLM with a
Poisson family, allowing for overdispersion as it is common in real-life
count data like these. To include time as a linear term, we can just include
that column name to the right of the <code>~</code> in the model formula:</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb88-1"><a href="generalized-linear-models.html#cb88-1"></a>mod_time &lt;-<span class="st"> </span><span class="kw">glm</span>(all <span class="op">~</span><span class="st"> </span>time, </span>
<span id="cb88-2"><a href="generalized-linear-models.html#cb88-2"></a>                <span class="dt">data =</span> obs, <span class="dt">family =</span> <span class="st">&quot;quasipoisson&quot;</span>)</span></code></pre></div>
<p>You can use the <code>augment</code> function from the <code>broom</code> package to pull out the
fitted estimate for each of the original observations and plot that, along
with the observed data, to get an idea of what this model has captured:</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="generalized-linear-models.html#cb89-1"></a>mod_time <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb89-2"><a href="generalized-linear-models.html#cb89-2"></a><span class="st">  </span><span class="kw">augment</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb89-3"><a href="generalized-linear-models.html#cb89-3"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> time)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb89-4"><a href="generalized-linear-models.html#cb89-4"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">y =</span> all), <span class="dt">alpha =</span> <span class="fl">0.4</span>, <span class="dt">size =</span> <span class="fl">0.5</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb89-5"><a href="generalized-linear-models.html#cb89-5"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">y =</span> <span class="kw">exp</span>(.fitted)), <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb89-6"><a href="generalized-linear-models.html#cb89-6"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Date in study&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;Expected mortality count&quot;</span>) </span></code></pre></div>
<p><img src="adv_epi_analysis_files/figure-html/unnamed-chunk-50-1.png" width="672" /></p>
<p>This linear trend captures the long-term trend in mortality rates fairly well in
this case. This won’t always be the case, as there may be some health
outcomes—or some study populations—where the long-term pattern over the
study period might be less linear than in this example. Further, the linear
term is completely unsuccessful in capturing the shorter-term trends in mortality
rate. These oscillate, and so would be impossible to capture over multiple
years with a linear trend.</p>
<p>Instead, it’s helpful to use a non-linear term for time in the model. We can
use a natural cubic spline for this, using the <code>ns</code> function from the <code>splines</code>
package. You will need to clarify how flexible the spline function should be,
and this can be specified through the degrees of freedom for the spline. A
spline with more degrees of freedom will be “wigglier” over a given data range
compared to a spline with fewer degrees of freedom. Let’s start by using
158 degrees of freedom, which translates to about 7 degrees of freedom per year:</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb90-1"><a href="generalized-linear-models.html#cb90-1"></a><span class="kw">library</span>(splines)</span>
<span id="cb90-2"><a href="generalized-linear-models.html#cb90-2"></a>mod_time_nonlin &lt;-<span class="st"> </span><span class="kw">glm</span>(all <span class="op">~</span><span class="st"> </span><span class="kw">ns</span>(time, <span class="dt">df =</span> <span class="dv">158</span>), </span>
<span id="cb90-3"><a href="generalized-linear-models.html#cb90-3"></a>                       <span class="dt">data =</span> obs, <span class="dt">family =</span> <span class="st">&quot;quasipoisson&quot;</span>)</span></code></pre></div>
<p>You can visualize the model results in a similar way to how we visualized the
last model. However, there is one extra step. The <code>augment</code> function only
carries through columns in the original data (<code>obs</code>) that were directly used
in fitting the model. Now that we’re using a transformation of the <code>time</code>
column, by wrapping it in <code>ns</code>, the <code>time</code> column is no longer included in the
<code>augment</code> output. However, we can easily add it back in using <code>mutate</code>,
pulling it from the original <code>obs</code> dataset, and then proceed as before.</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb91-1"><a href="generalized-linear-models.html#cb91-1"></a>mod_time_nonlin <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb91-2"><a href="generalized-linear-models.html#cb91-2"></a><span class="st">  </span><span class="kw">augment</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb91-3"><a href="generalized-linear-models.html#cb91-3"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">time =</span> obs<span class="op">$</span>time) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb91-4"><a href="generalized-linear-models.html#cb91-4"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> time)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb91-5"><a href="generalized-linear-models.html#cb91-5"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">y =</span> all), <span class="dt">alpha =</span> <span class="fl">0.4</span>, <span class="dt">size =</span> <span class="fl">0.5</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb91-6"><a href="generalized-linear-models.html#cb91-6"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">y =</span> <span class="kw">exp</span>(.fitted)), <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb91-7"><a href="generalized-linear-models.html#cb91-7"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Date in study&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;Expected mortality count&quot;</span>) </span></code></pre></div>
<p><img src="adv_epi_analysis_files/figure-html/unnamed-chunk-52-1.png" width="672" /></p>
<p>The non-linear term for time has allowed enough flexibility that the model now
captures both long-term and seasonal trends in the data.</p>
<p>You might wonder how many degrees of freedom you should use for this time spline. In practice,
researchers often using about 6–8 degrees of freedom per year of the study, in
the case of year-round data. You can explore how changing the degrees of freedom
changes the way the model fits to the observed data. As you use more degrees of
freedom, the line will capture very short-term effects, and may start to
interfere with the shorter-term associations between environmental exposures and
health risk that you are trying to capture. Even in the example model we just
fit, for example, it looks like the control for time may be capturing some
patterns that were likely caused by heatwaves (the rare summer peaks, including
one from the 1995 heatwave). Conversely, if too few degrees of freedom are used,
the model will shift to look much more like the linear model, with inadequate
control for seasonal patterns.</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="generalized-linear-models.html#cb92-1"></a><span class="co"># A model with many less d.f. for the time spline</span></span>
<span id="cb92-2"><a href="generalized-linear-models.html#cb92-2"></a>mod_time_nonlin_lowdf &lt;-<span class="st"> </span><span class="kw">glm</span>(all <span class="op">~</span><span class="st"> </span><span class="kw">ns</span>(time, <span class="dt">df =</span> <span class="dv">10</span>), </span>
<span id="cb92-3"><a href="generalized-linear-models.html#cb92-3"></a>                             <span class="dt">data =</span> obs, <span class="dt">family =</span> <span class="st">&quot;quasipoisson&quot;</span>)</span>
<span id="cb92-4"><a href="generalized-linear-models.html#cb92-4"></a>mod_time_nonlin_lowdf <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb92-5"><a href="generalized-linear-models.html#cb92-5"></a><span class="st">  </span><span class="kw">augment</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb92-6"><a href="generalized-linear-models.html#cb92-6"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">time =</span> obs<span class="op">$</span>time) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb92-7"><a href="generalized-linear-models.html#cb92-7"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> time)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb92-8"><a href="generalized-linear-models.html#cb92-8"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">y =</span> all), <span class="dt">alpha =</span> <span class="fl">0.4</span>, <span class="dt">size =</span> <span class="fl">0.5</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb92-9"><a href="generalized-linear-models.html#cb92-9"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">y =</span> <span class="kw">exp</span>(.fitted)), <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb92-10"><a href="generalized-linear-models.html#cb92-10"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Date in study&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;Expected mortality count&quot;</span>) </span></code></pre></div>
<p><img src="adv_epi_analysis_files/figure-html/unnamed-chunk-53-1.png" width="672" /></p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="generalized-linear-models.html#cb93-1"></a><span class="co"># A model with many more d.f. for the time spline</span></span>
<span id="cb93-2"><a href="generalized-linear-models.html#cb93-2"></a><span class="co"># (Takes a little while to run)</span></span>
<span id="cb93-3"><a href="generalized-linear-models.html#cb93-3"></a>mod_time_nonlin_highdf &lt;-<span class="st"> </span><span class="kw">glm</span>(all <span class="op">~</span><span class="st"> </span><span class="kw">ns</span>(time, <span class="dt">df =</span> <span class="dv">400</span>), </span>
<span id="cb93-4"><a href="generalized-linear-models.html#cb93-4"></a>                             <span class="dt">data =</span> obs, <span class="dt">family =</span> <span class="st">&quot;quasipoisson&quot;</span>)</span>
<span id="cb93-5"><a href="generalized-linear-models.html#cb93-5"></a>mod_time_nonlin_highdf <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb93-6"><a href="generalized-linear-models.html#cb93-6"></a><span class="st">  </span><span class="kw">augment</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb93-7"><a href="generalized-linear-models.html#cb93-7"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">time =</span> obs<span class="op">$</span>time) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb93-8"><a href="generalized-linear-models.html#cb93-8"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> time)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb93-9"><a href="generalized-linear-models.html#cb93-9"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">y =</span> all), <span class="dt">alpha =</span> <span class="fl">0.4</span>, <span class="dt">size =</span> <span class="fl">0.5</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb93-10"><a href="generalized-linear-models.html#cb93-10"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">y =</span> <span class="kw">exp</span>(.fitted)), <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb93-11"><a href="generalized-linear-models.html#cb93-11"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Date in study&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;Expected mortality count&quot;</span>) </span></code></pre></div>
<p><img src="adv_epi_analysis_files/figure-html/unnamed-chunk-54-1.png" width="672" /></p>
<p>In all cases, when you fit a non-linear function of an explanatory variable,
it will make the model summary results look much more complicated, e.g.:</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="generalized-linear-models.html#cb94-1"></a>mod_time_nonlin_lowdf <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb94-2"><a href="generalized-linear-models.html#cb94-2"></a><span class="st">  </span><span class="kw">tidy</span>()</span></code></pre></div>
<pre><code>## # A tibble: 11 x 5
##    term                estimate std.error statistic   p.value
##    &lt;chr&gt;                  &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
##  1 (Intercept)           5.26     0.00948    555.   0.       
##  2 ns(time, df = 10)1   -0.0260   0.0119      -2.18 2.93e-  2
##  3 ns(time, df = 10)2   -0.0860   0.0155      -5.56 2.85e-  8
##  4 ns(time, df = 10)3   -0.114    0.0139      -8.15 4.01e- 16
##  5 ns(time, df = 10)4   -0.196    0.0151     -13.0  4.47e- 38
##  6 ns(time, df = 10)5   -0.187    0.0148     -12.6  2.80e- 36
##  7 ns(time, df = 10)6   -0.315    0.0154     -20.5  5.62e- 91
##  8 ns(time, df = 10)7   -0.337    0.0154     -21.9  1.95e-103
##  9 ns(time, df = 10)8   -0.358    0.0135     -26.5  1.56e-148
## 10 ns(time, df = 10)9   -0.467    0.0244     -19.2  4.49e- 80
## 11 ns(time, df = 10)10  -0.392    0.0126     -31.2  8.01e-202</code></pre>
<p>You can see that there are multiple model coefficients for the variable fit
using a spline function, the same as the number of degrees of freedom. These
model coefficients are very hard to interpret on their own. When we are using
the spline to <em>control</em> for a factor that might serve as a confounder of the
association of interest, we typically won’t need to try to interpret these
model coefficients—instead, we are interested in accounting for how this
factor explains variability in the outcome, without needing to quantify the
association as a key result. However, there are also cases where we want to
use a spline to fit the association with the exposure that we are interested
in. In this case, we will want to be able to interpret model coefficients from
the spline. Later in this chapter, we will introduce the <code>dlnm</code> package, which
includes functions to both fit and interpret natural cubic splines within
GLMs for environmental epidemiology.</p>
<ol start="2" style="list-style-type: decimal">
<li><strong>Start from the last model created in the last chapter and add control for
long-term and seasonal trends over the study period.</strong></li>
</ol>
<p>The last model fit in the last chapter was the following, which fits for the
association between a linear term of temperature and mortality risk, with control
for day of week:</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb96-1"><a href="generalized-linear-models.html#cb96-1"></a>mod_ctrl_dow &lt;-<span class="st"> </span><span class="kw">glm</span>(all <span class="op">~</span><span class="st"> </span>tmean <span class="op">+</span><span class="st"> </span><span class="kw">factor</span>(dow, <span class="dt">ordered =</span> <span class="ot">FALSE</span>), </span>
<span id="cb96-2"><a href="generalized-linear-models.html#cb96-2"></a>                    <span class="dt">data =</span> obs, <span class="dt">family =</span> <span class="st">&quot;quasipoisson&quot;</span>)</span></code></pre></div>
<p>To add control for long-term and seasonal trends, you can take the natural cubic
spline function of temperature that you just fit and include it among the
explanatory / independent variables from the model in the last chapter. If you
want to control for only long-term trends, a linear term of the <code>time</code> column
could work, as we discovered in the first part of this chapter’s exercise.
However, seasonal trends could certainly confound the association of interest.
Mortality rates have a clear seasonal pattern, and temperature does as well,
and these patterns create the potential for confounding when we look at how
temperature and mortality risk are associated, beyond any seasonally-driven
pathways.</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb97-1"><a href="generalized-linear-models.html#cb97-1"></a>mod_ctrl_dow_time &lt;-<span class="st"> </span><span class="kw">glm</span>(all <span class="op">~</span><span class="st"> </span>tmean <span class="op">+</span><span class="st"> </span><span class="kw">factor</span>(dow, <span class="dt">ordered =</span> <span class="ot">FALSE</span>) <span class="op">+</span></span>
<span id="cb97-2"><a href="generalized-linear-models.html#cb97-2"></a><span class="st">                           </span><span class="kw">ns</span>(time, <span class="dt">df =</span> <span class="dv">158</span>), </span>
<span id="cb97-3"><a href="generalized-linear-models.html#cb97-3"></a>                         <span class="dt">data =</span> obs, <span class="dt">family =</span> <span class="st">&quot;quasipoisson&quot;</span>)</span></code></pre></div>
<p>You can see the influence of this seasonal confounding if you look at the model
results. When we look at the results from the model that did not control for
long-term and seasonal trends, we get an estimate that mortality rates tend to
be lower on days with higher temperature, with a negative term for <code>tmean</code>:</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb98-1"><a href="generalized-linear-models.html#cb98-1"></a>mod_ctrl_dow <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb98-2"><a href="generalized-linear-models.html#cb98-2"></a><span class="st">  </span><span class="kw">tidy</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb98-3"><a href="generalized-linear-models.html#cb98-3"></a><span class="st">  </span><span class="kw">filter</span>(term <span class="op">==</span><span class="st"> &quot;tmean&quot;</span>)</span></code></pre></div>
<pre><code>## # A tibble: 1 x 5
##   term  estimate std.error statistic p.value
##   &lt;chr&gt;    &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;
## 1 tmean  -0.0148  0.000354     -41.7       0</code></pre>
<p>Conversely, when we include control for long-term and seasonal trends, the
estimated association between mortality rates and temperature is reversed,
estimating increased mortality rates on days with higher temperature, <em>controlling
for long-term and seasonal trends</em>:</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb100-1"><a href="generalized-linear-models.html#cb100-1"></a>mod_ctrl_dow_time <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb100-2"><a href="generalized-linear-models.html#cb100-2"></a><span class="st">  </span><span class="kw">tidy</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb100-3"><a href="generalized-linear-models.html#cb100-3"></a><span class="st">  </span><span class="kw">filter</span>(term <span class="op">==</span><span class="st"> &quot;tmean&quot;</span>)</span></code></pre></div>
<pre><code>## # A tibble: 1 x 5
##   term  estimate std.error statistic  p.value
##   &lt;chr&gt;    &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
## 1 tmean  0.00370  0.000395      9.36 1.02e-20</code></pre>
<ol start="3" style="list-style-type: decimal">
<li><strong>Refine your model to fit for a non-linear, rather than linear, function
of temperature in the model.</strong></li>
</ol>
<p>You can use a spline in the same way to fit a non-linear function for the
exposure of interest in the model (temperature). We’ll start there. However,
as mentioned earlier, it’s a bit tricky to interpret the coefficients from the
fit model—you no longer generate a single coefficient for the exposure of
interest, but instead several related to the spline. Therefore, once we show
how to fit using <code>ns</code> directly, we’ll show how you can do the same thing using
specialized functions in the <code>dlnm</code> package. This package includes a lot of
nice functions for not only fitting an association using a non-linear term,
but also for interpreting the results after the model is fit.</p>
<p>First, here is code that can be used to fit the model using <code>ns</code> directly,
similarly to the approach we used to control for temporal patterns with a
flexible function:</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb102-1"><a href="generalized-linear-models.html#cb102-1"></a>mod_ctrl_nl_temp &lt;-<span class="st"> </span><span class="kw">glm</span>(all <span class="op">~</span><span class="st"> </span><span class="kw">ns</span>(tmean, <span class="dv">4</span>) <span class="op">+</span><span class="st"> </span><span class="kw">factor</span>(dow, <span class="dt">ordered =</span> <span class="ot">FALSE</span>) <span class="op">+</span></span>
<span id="cb102-2"><a href="generalized-linear-models.html#cb102-2"></a><span class="st">                          </span><span class="kw">ns</span>(time, <span class="dt">df =</span> <span class="dv">158</span>), </span>
<span id="cb102-3"><a href="generalized-linear-models.html#cb102-3"></a>                        <span class="dt">data =</span> obs, <span class="dt">family =</span> <span class="st">&quot;quasipoisson&quot;</span>)</span></code></pre></div>
<p>We can plot the predicted values from this fitted model (red points in the plot below)
compared to the observed data (black dots) using our usual method of using <code>augment</code> to
extract the predicted values:</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb103-1"><a href="generalized-linear-models.html#cb103-1"></a>mod_ctrl_nl_temp <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb103-2"><a href="generalized-linear-models.html#cb103-2"></a><span class="st">  </span><span class="kw">augment</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb103-3"><a href="generalized-linear-models.html#cb103-3"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">tmean =</span> obs<span class="op">$</span>tmean) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb103-4"><a href="generalized-linear-models.html#cb103-4"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> tmean)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb103-5"><a href="generalized-linear-models.html#cb103-5"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">y =</span> all), <span class="dt">alpha =</span> <span class="fl">0.4</span>, <span class="dt">size =</span> <span class="fl">0.5</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb103-6"><a href="generalized-linear-models.html#cb103-6"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">y =</span> <span class="kw">exp</span>(.fitted)), <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>,  <span class="dt">size =</span> <span class="fl">0.4</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb103-7"><a href="generalized-linear-models.html#cb103-7"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Daily mean temperature&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;Expected mortality count&quot;</span>) </span></code></pre></div>
<p><img src="adv_epi_analysis_files/figure-html/unnamed-chunk-61-1.png" width="672" /></p>
<p>However, these predictions are very variable at any given temperature. This reflects how
other independent variables, like long-term and seasonal trends, explain variability in
mortality. This makes sense, but it makes it a bit hard to investigate the role of temperature
specifically. Let’s look, then, at some other options for viewing the results that will
help us focus on the association of the exposure we care about (temperature) with the outcome.</p>
<p>The next part has a lot of steps, so it might at first seem confusing. However, fortunately
we won’t always have to do all the steps ourselves—there is a nice R package that
will help us. We’ll look at the process first, though, and then the easier way to use a
package to help with some of the steps. Also, this process gives us a first look at how
the idea of basis functions work. We’ll later expand on these to look at non-linear
relationships with the exposure at different lag times, using cross-basis functions, so this
forms a starting point for moving into the idea of a cross-basis.</p>
<p>First, we need to think about how temperature gets included in the regression
model—specifically, as a function of <em>basis variables</em> rather than as a single variable.
In other words, to include temperature as a nonlinear function, we’re going to create
a structure in the regression equation that includes the variable of temperature in
several different terms, in different transformations in each term. I simple example of this
is a second-degree polynomial. If we wanted to include a second-order polynomial function
of temperature in the regression, then we’d use the following basis:</p>
<p><span class="math display">\[
\beta_1 T + \beta_2 T^2
\]</span></p>
<p>Notice that here we’re using the same independent variable (<span class="math inline">\(T\)</span>, which stands for daily
temperature), but we’re including both untransformed <span class="math inline">\(T\)</span> and also <span class="math inline">\(T\)</span> squared. This function
of <span class="math inline">\(T\)</span> might go into the regression equation as something like:</p>
<p><span class="math display">\[
E(Y) = \alpha + \beta_1 T + \beta_2 T^2 + ns(time) + \mathbf{\gamma^{&#39;}D}
\]</span>
where <span class="math inline">\(\alpha\)</span> is the intercept, <span class="math inline">\(ns(time)\)</span> is a natural cubic spline that controls for
time (long-term and seasonal trends) and <span class="math inline">\(\mathbf{D}\)</span> is day of week, with <span class="math inline">\(\mathbf{\gamma}\)</span> as
the set of coefficients associated with day of week. (Here, I’ve included the outcome,
<span class="math inline">\(Y\)</span>, untransformed, as you would for a linear regression, but of course the same idea
works with Poisson regression, when you’d instead have <span class="math inline">\(log(E(Y))\)</span> on the left of the
equation.)</p>
<p>When you fit a regression model in a program like R, it sets up the observed data into
something called a <em>model matrix</em>, where it has the values for each observation for each of
the independent variables you want to include, plus a column of “1”s for the intercept, if you
model structure includes one. The regression model will fit a coefficient
for each of these columns in the model matrix. In a simple case, this model matrix will just
repeat each of your independent variables. For example, the model matrix for the model
<code>mod_overdisp_reg</code>, which we fit in the last chapter and which included only an intercept
and a linear term for <code>tmean</code>, looks like this (the <code>model.matrix</code> function will give you
the model matrix of any <code>glm</code> object that you get by running the <code>glm</code> function in R):</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb104-1"><a href="generalized-linear-models.html#cb104-1"></a>mod_ovdisp_reg <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb104-2"><a href="generalized-linear-models.html#cb104-2"></a><span class="st">  </span><span class="kw">model.matrix</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb104-3"><a href="generalized-linear-models.html#cb104-3"></a><span class="st">  </span><span class="kw">head</span>()</span></code></pre></div>
<pre><code>##   (Intercept)    tmean
## 1           1 3.913589
## 2           1 5.547919
## 3           1 4.385564
## 4           1 5.431046
## 5           1 6.867855
## 6           1 9.232628</code></pre>
<p>We already start using the idea of basis variables when we include categorical variables, like
day of week. Here is the model matrix for the <code>mod_ctrl_dow</code> model that we fit in the last
chapter:</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb106-1"><a href="generalized-linear-models.html#cb106-1"></a>mod_ctrl_dow <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb106-2"><a href="generalized-linear-models.html#cb106-2"></a><span class="st">  </span><span class="kw">model.matrix</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb106-3"><a href="generalized-linear-models.html#cb106-3"></a><span class="st">  </span><span class="kw">head</span>()</span></code></pre></div>
<pre><code>##   (Intercept)    tmean factor(dow, ordered = FALSE)Mon
## 1           1 3.913589                               1
## 2           1 5.547919                               0
## 3           1 4.385564                               0
## 4           1 5.431046                               0
## 5           1 6.867855                               0
## 6           1 9.232628                               0
##   factor(dow, ordered = FALSE)Tue factor(dow, ordered = FALSE)Wed
## 1                               0                               0
## 2                               1                               0
## 3                               0                               1
## 4                               0                               0
## 5                               0                               0
## 6                               0                               0
##   factor(dow, ordered = FALSE)Thu factor(dow, ordered = FALSE)Fri
## 1                               0                               0
## 2                               0                               0
## 3                               0                               0
## 4                               1                               0
## 5                               0                               1
## 6                               0                               0
##   factor(dow, ordered = FALSE)Sat
## 1                               0
## 2                               0
## 3                               0
## 4                               0
## 5                               0
## 6                               1</code></pre>
<p>You can see that the regression call broke the day-of-week variable up into a set of indicator variables, which
equal either 1 or 0. There will be one less of these than the number of categories for the
variable; in otherwords, if the categorical variable took two values (Weekend / Weekday), then
this would be covered by a single column; since there are seven days in the week, the
day-of-week variable breaks into six (7 - 1) columns. The first level of the categories
(Sunday in this case) serves as a baseline and doesn’t get a value. The others levels
(Monday, Tuesday, etc.) each get their own indicator variable—so, their own column in
the model matrix—which equals “1” on that day (i.e., “1” for the Monday column if the date
of the observation is a Monday) and “0” on all other days.</p>
<p>Now let’s go back and look at the example of including temperature in the model as a nonlinear
function, starting with the simple example of using a second-degree polynomial. What would
the basis for that look like? We can find out by fitting the model and then looking at the
model matrix (the <code>I()</code> function lets us specify a transformation of a column from the
data when we set up the regression equation structure in <code>glm</code>):</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb108-1"><a href="generalized-linear-models.html#cb108-1"></a>mod_polynomial_temp &lt;-<span class="st"> </span><span class="kw">glm</span>(all <span class="op">~</span><span class="st"> </span>tmean <span class="op">+</span><span class="st"> </span><span class="kw">I</span>(tmean <span class="op">^</span><span class="st"> </span><span class="dv">2</span>), </span>
<span id="cb108-2"><a href="generalized-linear-models.html#cb108-2"></a>                           <span class="dt">data =</span> obs, <span class="dt">family =</span> <span class="st">&quot;quasipoisson&quot;</span>)</span>
<span id="cb108-3"><a href="generalized-linear-models.html#cb108-3"></a>mod_polynomial_temp <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb108-4"><a href="generalized-linear-models.html#cb108-4"></a><span class="st">  </span><span class="kw">model.matrix</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb108-5"><a href="generalized-linear-models.html#cb108-5"></a><span class="st">  </span><span class="kw">head</span>()</span></code></pre></div>
<pre><code>##   (Intercept)    tmean I(tmean^2)
## 1           1 3.913589   15.31618
## 2           1 5.547919   30.77941
## 3           1 4.385564   19.23317
## 4           1 5.431046   29.49627
## 5           1 6.867855   47.16743
## 6           1 9.232628   85.24142</code></pre>
<p>You can see that this has created two columns based on the temperature variable, one with
it untransformed and one with it squared. The regression will estimate coefficients for each
of these basis variables of temperature, and then that allows you to fit a model with a
function of temperature, rather than solely temperature. Here are the coefficients from
this model:</p>
<div class="sourceCode" id="cb110"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb110-1"><a href="generalized-linear-models.html#cb110-1"></a>mod_polynomial_temp <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb110-2"><a href="generalized-linear-models.html#cb110-2"></a><span class="st">  </span><span class="kw">tidy</span>()</span></code></pre></div>
<pre><code>## # A tibble: 3 x 5
##   term         estimate std.error statistic   p.value
##   &lt;chr&gt;           &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
## 1 (Intercept)  5.31     0.00675       787.  0.       
## 2 tmean       -0.0298   0.00126       -23.6 2.27e-119
## 3 I(tmean^2)   0.000667 0.0000538      12.4 5.70e- 35</code></pre>
<p>Therefore, it’s fit the following model to describe the association between temperature and
mortality:</p>
<p><span class="math display">\[
log(E(Y)) = 5.3092 - 0.0298T + 0.0007T^2
\]</span>
If you want to estimate the relative risk of mortality at 15 degrees Celsius versus 10
degrees Celsius with this model (which is confounded by long-term and seasonal trends, so
has some issues we’ll want to fix), you can take the following process. Take the two
equations for the expected mortality when <span class="math inline">\(T\)</span> is 15 and 10, respectively:</p>
<p><span class="math display">\[
log(E(Y|T=15)) = 5.3092 - 0.0298(15) + 0.0007(15^2) \\
log(E(Y|T=10)) = 5.3092 - 0.0298(10) + 0.0007(10^2)  
\]</span>
If you subtract the second from the first, you get:</p>
<p><span class="math display">\[
log(E(Y|T=15)) - log(E(Y|T=10)) = (5.3092 - 5.3092) - 0.0298(15 - 10) + 0.0007(15^2 - 10^2)
\]</span>
which simplifies to (if the left part isn’t clear, review the rules for how you can manipulate
logarithms):</p>
<p><span class="math display">\[
log(\frac{E(Y|T=15)}{E(Y|T=10)}) = - 0.0298(5) + 0.0007(125) = -0.0615
\]</span>
Exponentiate both sides, to get to the relative risk at 15 degrees versus 10 degrees (in
other words, the ratio of expected mortality at 15 degrees to that at 10 degrees):</p>
<p><span class="math display">\[
\frac{E(Y|T=15)}{E(Y|T=10)} = e^{-0.0615} =  0.94
\]</span>
You can see that the basis variables are great in helping us explore how an independent
variable might be related to the outcome in a non-linear way, but there’s a bit of a cost
in terms of us needing to take some extra steps to interpret the results from that model.
Also, note that there’s not a single coefficient that we can extract from the model as
a summary of the relationship. Instead, we needed to pick a reference temperature (10 degrees
in this example) and compare to that to get an estimated relative risk. We’ll see the
same pattern as we move to using natural cubic splines to create the basis variables for
temperature.</p>
<p>Now let’s move to a spline. The function the spline runs to transform the temperature
variable into the different basis variables is more complex than for the polynomial example,
but the result is similar: you get several columns to fit in the model for a variable, compared
to the single column you would include if you were only fitting a linear term. If you
take a look at the output of running the <code>ns</code> function on temperature in the data, you can
see that it creates several new columns (one for each degree of freedom), which will be the
basis variables in the regression:</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb112-1"><a href="generalized-linear-models.html#cb112-1"></a><span class="kw">ns</span>(obs<span class="op">$</span>tmean, <span class="dt">df =</span> <span class="dv">4</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb112-2"><a href="generalized-linear-models.html#cb112-2"></a><span class="st">  </span><span class="kw">head</span>()</span></code></pre></div>
<pre><code>##              1           2         3          4
## [1,] 0.1769619 -0.20432696 0.4777110 -0.2733841
## [2,] 0.2860253 -0.19686120 0.4602563 -0.2633951
## [3,] 0.2049283 -0.20410506 0.4771922 -0.2730872
## [4,] 0.2770456 -0.19804188 0.4630167 -0.2649748
## [5,] 0.4012496 -0.17595974 0.4113892 -0.2354295
## [6,] 0.6581858 -0.09844302 0.2476396 -0.1417190</code></pre>
<p>The output from <code>ns</code> also has some metadata, included in the attributes of the object, that
have some other information about the spline function, including where the knots were
placed and where the boundary knots (which are at the outer ranges of the data) are placed.
You can the <code>str</code> function to explore both the data and metadata stored in this object:</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb114-1"><a href="generalized-linear-models.html#cb114-1"></a><span class="kw">ns</span>(obs<span class="op">$</span>tmean, <span class="dt">df =</span> <span class="dv">4</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb114-2"><a href="generalized-linear-models.html#cb114-2"></a><span class="st">  </span><span class="kw">str</span>()</span></code></pre></div>
<pre><code>##  &#39;ns&#39; num [1:8279, 1:4] 0.177 0.286 0.205 0.277 0.401 ...
##  - attr(*, &quot;dimnames&quot;)=List of 2
##   ..$ : NULL
##   ..$ : chr [1:4] &quot;1&quot; &quot;2&quot; &quot;3&quot; &quot;4&quot;
##  - attr(*, &quot;degree&quot;)= int 3
##  - attr(*, &quot;knots&quot;)= Named num [1:3] 7.47 11.47 15.93
##   ..- attr(*, &quot;names&quot;)= chr [1:3] &quot;25%&quot; &quot;50%&quot; &quot;75%&quot;
##  - attr(*, &quot;Boundary.knots&quot;)= num [1:2] -5.5 29.1
##  - attr(*, &quot;intercept&quot;)= logi FALSE</code></pre>
<p>This is saying, for example, that the internal knots for this spline were put at the
25th, 50th, and 75th quantiles of the temperature data, where were 7.47 degrees, 11.47 degrees,
and 15.93 degrees. (The defaults for <code>ns</code> is to place knots evenly at percentiles, based
on the number of degrees of freedom you specify. You can change this by placing the knots
“by hand”, using the <code>knots</code> argument in the <code>ns</code> function.)</p>
<p>This spline object can be used not just for its basis values, but also to “predict” new
basis values for a new set of temperature values. For example, you could figure out
what the basis values from this spline would be for every degree of temperature between
-6 and 29 using the following code:</p>
<div class="sourceCode" id="cb116"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb116-1"><a href="generalized-linear-models.html#cb116-1"></a>temp_spline &lt;-<span class="st"> </span><span class="kw">ns</span>(obs<span class="op">$</span>tmean, <span class="dt">df =</span> <span class="dv">4</span>)</span>
<span id="cb116-2"><a href="generalized-linear-models.html#cb116-2"></a>temp_spline_preds &lt;-<span class="st"> </span><span class="kw">predict</span>(temp_spline, <span class="dt">newx =</span> <span class="dv">-5</span><span class="op">:</span><span class="dv">30</span>)</span>
<span id="cb116-3"><a href="generalized-linear-models.html#cb116-3"></a>temp_spline_preds <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb116-4"><a href="generalized-linear-models.html#cb116-4"></a><span class="st">  </span><span class="kw">head</span>()</span></code></pre></div>
<pre><code>##                 1           2          3           4
## [1,] 2.689545e-05 -0.01606406 0.03755734 -0.02149328
## [2,] 7.189726e-04 -0.04768237 0.11148013 -0.06379775
## [3,] 3.321933e-03 -0.07825364 0.18295494 -0.10470130
## [4,] 9.107577e-03 -0.10708098 0.25035250 -0.14327152
## [5,] 1.934771e-02 -0.13346753 0.31204355 -0.17857602
## [6,] 3.531412e-02 -0.15671641 0.36639881 -0.20968240</code></pre>
<p>This is handy, because it will help us visualize the relationship we fit in a regression
model—we can start with these basis values for each degree in our temperature range, and
then use the regression coefficients for each basis variable to estimate relative risk
at that temperature compared to a reference temperature, exactly as we did in the equations
for the polynomial function of temperature earlier, comparing 15 degrees C to the reference
of 10 degrees.</p>
<p>All we need now are the regression coefficients for each of these temperature basis
variables. We can extract those from the model we fit earlier, where we included
<code>ns(tmean, 4)</code> as one of the model terms. Here, I’m using <code>tidy</code> to get the model
coefficients and then, because there are <em>lots</em> of them (from fitting a spline for
time with lots of degrees of freedom), I’m using the <code>str_detect</code> function from the
<code>stringr</code> package to pick out just those with “tmean” in the <code>term</code> column:</p>
<div class="sourceCode" id="cb118"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb118-1"><a href="generalized-linear-models.html#cb118-1"></a>mod_ctrl_nl_temp <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb118-2"><a href="generalized-linear-models.html#cb118-2"></a><span class="st">  </span><span class="kw">tidy</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb118-3"><a href="generalized-linear-models.html#cb118-3"></a><span class="st">  </span><span class="kw">filter</span>(<span class="kw">str_detect</span>(term, <span class="st">&quot;tmean&quot;</span>))</span></code></pre></div>
<pre><code>## # A tibble: 4 x 5
##   term          estimate std.error statistic  p.value
##   &lt;chr&gt;            &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
## 1 ns(tmean, 4)1  -0.0700    0.0135    -5.18  2.30e- 7
## 2 ns(tmean, 4)2  -0.0660    0.0126    -5.24  1.61e- 7
## 3 ns(tmean, 4)3   0.0110    0.0313     0.350 7.26e- 1
## 4 ns(tmean, 4)4   0.347     0.0177    19.6   2.02e-83</code></pre>
<p>You can add on <code>pull</code> to pull out just the <code>estimate</code> column as a vector, which will be
helpful when we want to multiple these coefficients by the basis values for each degree
of temperature across our temperature range:</p>
<div class="sourceCode" id="cb120"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb120-1"><a href="generalized-linear-models.html#cb120-1"></a>temp_spline_ests &lt;-<span class="st"> </span>mod_ctrl_nl_temp <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb120-2"><a href="generalized-linear-models.html#cb120-2"></a><span class="st">  </span><span class="kw">tidy</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb120-3"><a href="generalized-linear-models.html#cb120-3"></a><span class="st">  </span><span class="kw">filter</span>(<span class="kw">str_detect</span>(term, <span class="st">&quot;tmean&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb120-4"><a href="generalized-linear-models.html#cb120-4"></a><span class="st">  </span><span class="kw">pull</span>(estimate)</span>
<span id="cb120-5"><a href="generalized-linear-models.html#cb120-5"></a>temp_spline_ests</span></code></pre></div>
<pre><code>## [1] -0.06995454 -0.06596939  0.01095574  0.34659715</code></pre>
<p>Now, let’s put this together to see how relative risk of mortality changes as you move
across the temperature range! First, we can set up a dataframe that has a column with
each unit of temperature across our range—these are the temperatures where we want to
estimate relative risk—and then the estimated relative risk at that temperature. By
default, we’ll be comparing to the lowest temperature in the original data, but we’ll talk
in a minute about how to adjust to a different reference temperature. You can use
matrix multiplication (<code>%*%</code>) as a shorthand way to multiple each column of the spline
basis variables from <code>temp_spline_preds</code> by its estimated coefficient from the regression
model, saved in <code>temp_spline_ests</code>, and then add all of those values together (this is
the same idea as what we did in the equations earlier, for the polynomial basis). Then,
to get from log relative risk to relative risk, we’ll exponentiate that with <code>exp</code>. You
can see the first rows of the results below:</p>
<div class="sourceCode" id="cb122"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb122-1"><a href="generalized-linear-models.html#cb122-1"></a>pred_temp_function &lt;-<span class="st"> </span><span class="kw">tibble</span>(</span>
<span id="cb122-2"><a href="generalized-linear-models.html#cb122-2"></a>  <span class="dt">temp =</span> <span class="dv">-5</span><span class="op">:</span><span class="dv">30</span>, </span>
<span id="cb122-3"><a href="generalized-linear-models.html#cb122-3"></a>  <span class="dt">temp_func =</span> temp_spline_preds <span class="op">%*%</span><span class="st"> </span>temp_spline_ests,</span>
<span id="cb122-4"><a href="generalized-linear-models.html#cb122-4"></a>  <span class="dt">rr =</span> <span class="kw">exp</span>(temp_func)</span>
<span id="cb122-5"><a href="generalized-linear-models.html#cb122-5"></a>)</span>
<span id="cb122-6"><a href="generalized-linear-models.html#cb122-6"></a></span>
<span id="cb122-7"><a href="generalized-linear-models.html#cb122-7"></a>pred_temp_function <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb122-8"><a href="generalized-linear-models.html#cb122-8"></a><span class="st">  </span><span class="kw">head</span>()</span></code></pre></div>
<pre><code>## # A tibble: 6 x 3
##    temp temp_func[,1] rr[,1]
##   &lt;int&gt;         &lt;dbl&gt;  &lt;dbl&gt;
## 1    -5      -0.00598  0.994
## 2    -4      -0.0178   0.982
## 3    -3      -0.0294   0.971
## 4    -2      -0.0405   0.960
## 5    -1      -0.0510   0.950
## 6     0      -0.0608   0.941</code></pre>
<p>This is now very easy to plot, with a reference line added at a relative risk of 1.0:</p>
<div class="sourceCode" id="cb124"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb124-1"><a href="generalized-linear-models.html#cb124-1"></a><span class="kw">ggplot</span>(pred_temp_function, <span class="kw">aes</span>(<span class="dt">x =</span> temp, <span class="dt">y =</span> rr)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb124-2"><a href="generalized-linear-models.html#cb124-2"></a><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span><span class="st"> </span></span>
<span id="cb124-3"><a href="generalized-linear-models.html#cb124-3"></a><span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span><span class="st"> </span></span>
<span id="cb124-4"><a href="generalized-linear-models.html#cb124-4"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Temperature&quot;</span>, </span>
<span id="cb124-5"><a href="generalized-linear-models.html#cb124-5"></a>       <span class="dt">y =</span> <span class="st">&quot;Relative Risk&quot;</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb124-6"><a href="generalized-linear-models.html#cb124-6"></a><span class="st">  </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="fl">1.0</span>, <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>, <span class="dt">linetype =</span> <span class="dv">2</span>)</span></code></pre></div>
<p><img src="adv_epi_analysis_files/figure-html/unnamed-chunk-73-1.png" width="672" /></p>
<p>We might want to shift this, so we’re comparing the temperature at which mortality risk
is lowest (sometimes called the <em>minimum mortality temperature</em>). This tends to be at
milder temperatures, in the middle of our range, rather than at the minimum temperature in
the range. To start, let’s see what temperature aligns with the lowest relative risk of
mortality:</p>
<div class="sourceCode" id="cb125"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb125-1"><a href="generalized-linear-models.html#cb125-1"></a>pred_temp_function <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb125-2"><a href="generalized-linear-models.html#cb125-2"></a><span class="st">  </span><span class="kw">filter</span>(rr <span class="op">==</span><span class="st"> </span><span class="kw">min</span>(rr))</span></code></pre></div>
<pre><code>## # A tibble: 1 x 3
##    temp temp_func[,1] rr[,1]
##   &lt;int&gt;         &lt;dbl&gt;  &lt;dbl&gt;
## 1     6       -0.0938  0.911</code></pre>
<p>We can therefore realign so that the relative risk equals 1.0 when the temperature is 7 degrees
C, and all other relative risks are relative to a reference temperature of 7 degrees C:</p>
<div class="sourceCode" id="cb127"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb127-1"><a href="generalized-linear-models.html#cb127-1"></a>pred_temp_function &lt;-<span class="st"> </span>pred_temp_function <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb127-2"><a href="generalized-linear-models.html#cb127-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">temp_func_reset =</span> temp_func <span class="op">-</span><span class="st"> </span>temp_func[temp <span class="op">==</span><span class="st"> </span><span class="dv">7</span>],</span>
<span id="cb127-3"><a href="generalized-linear-models.html#cb127-3"></a>         <span class="dt">rr_reset =</span> <span class="kw">exp</span>(temp_func_reset)</span>
<span id="cb127-4"><a href="generalized-linear-models.html#cb127-4"></a>)</span>
<span id="cb127-5"><a href="generalized-linear-models.html#cb127-5"></a></span>
<span id="cb127-6"><a href="generalized-linear-models.html#cb127-6"></a><span class="kw">ggplot</span>(pred_temp_function, <span class="kw">aes</span>(<span class="dt">x =</span> temp, <span class="dt">y =</span> rr_reset)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb127-7"><a href="generalized-linear-models.html#cb127-7"></a><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span><span class="st"> </span></span>
<span id="cb127-8"><a href="generalized-linear-models.html#cb127-8"></a><span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span><span class="st"> </span></span>
<span id="cb127-9"><a href="generalized-linear-models.html#cb127-9"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Temperature&quot;</span>, </span>
<span id="cb127-10"><a href="generalized-linear-models.html#cb127-10"></a>       <span class="dt">y =</span> <span class="st">&quot;Relative Risk&quot;</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb127-11"><a href="generalized-linear-models.html#cb127-11"></a><span class="st">  </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="fl">1.0</span>, <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>, <span class="dt">linetype =</span> <span class="dv">2</span>)</span></code></pre></div>
<p><img src="adv_epi_analysis_files/figure-html/unnamed-chunk-75-1.png" width="672" /></p>
<p>This is a fairly cumbersome process, as you’ve seen with this example, and it would be a
pain if we had to do it every time we wanted to visualize and explore results from fitting
regressions that include basis variables from splines. Fortunately, there’s a nice R package
called <code>dlnm</code> (for “distributed lag nonlinear models”) that will help take care of a lot of
these “under the hood” steps for us. Even better, this package will let us move on to more
complex crossbasis functions, where we fit non-linear functions in two dimensions, and help
us visualize and interpret results from those models.</p>
<p>To start, make sure you have the <code>dlnm</code> package installed on your computer, and then load
it in your R session. This package has a function called <code>crossbasis</code> that lets you build
a crossbasis function to use in a regression model. We’ll talk more about these types
of functions later in this chapter; for right now, we’ll be a bit simpler and just use it
to create our spline function of temperature.</p>
<p>In the <code>crossbasis</code> function, you start by putting in the vector of the variable that you
want to expand into basis variables. In our case, this is temperature, which we have saved
as the <code>tmean</code> column in the <code>obs</code> dataset. You use the <code>argvar</code> to give some information
about the basis you want to use for that variable. This will both include the type of
basis function (<code>"ns"</code> for a natural cubic spline), and then also arguments you want to
pass to that basis function, like degrees of freedom (<code>df</code>) or knot locations (<code>knots</code>)
if you’re fitting a spline. The other arguments allow you to specify a function of lagged
time; we won’t use that yet, so you can just include <code>lag = 0</code> and <code>arglag = list(fun = "integer")</code> to create a crossbasis where we only consider same-day effects in a simple way.
If you look at the output, you’ll see it’s very similar to the basis created by the
<code>ns</code> call earlier (in fact, the values in each column should be identical):</p>
<div class="sourceCode" id="cb128"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb128-1"><a href="generalized-linear-models.html#cb128-1"></a><span class="kw">library</span>(dlnm)</span>
<span id="cb128-2"><a href="generalized-linear-models.html#cb128-2"></a>temp_basis &lt;-<span class="st"> </span><span class="kw">crossbasis</span>(obs<span class="op">$</span>tmean, <span class="dt">lag =</span> <span class="dv">0</span>, </span>
<span id="cb128-3"><a href="generalized-linear-models.html#cb128-3"></a>                         <span class="dt">argvar =</span> <span class="kw">list</span>(<span class="dt">fun =</span> <span class="st">&quot;ns&quot;</span>, <span class="dt">df =</span> <span class="dv">4</span>), </span>
<span id="cb128-4"><a href="generalized-linear-models.html#cb128-4"></a>                         <span class="dt">arglag =</span> <span class="kw">list</span>(<span class="dt">fun =</span> <span class="st">&quot;integer&quot;</span>))</span>
<span id="cb128-5"><a href="generalized-linear-models.html#cb128-5"></a>temp_basis <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb128-6"><a href="generalized-linear-models.html#cb128-6"></a><span class="st">  </span><span class="kw">head</span>()</span></code></pre></div>
<pre><code>##          v1.l1       v2.l1     v3.l1      v4.l1
## [1,] 0.1769619 -0.20432696 0.4777110 -0.2733841
## [2,] 0.2860253 -0.19686120 0.4602563 -0.2633951
## [3,] 0.2049283 -0.20410506 0.4771922 -0.2730872
## [4,] 0.2770456 -0.19804188 0.4630167 -0.2649748
## [5,] 0.4012496 -0.17595974 0.4113892 -0.2354295
## [6,] 0.6581858 -0.09844302 0.2476396 -0.1417190</code></pre>
<p>To estimate the regression coefficients, we’ll put this whole crossbasis in as one of
our terms in the <code>glm</code> regression equation:</p>
<div class="sourceCode" id="cb130"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb130-1"><a href="generalized-linear-models.html#cb130-1"></a>dlnm_mod_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw">glm</span>(all <span class="op">~</span><span class="st"> </span>temp_basis <span class="op">+</span><span class="st"> </span><span class="kw">factor</span>(dow, <span class="dt">ordered =</span> <span class="ot">FALSE</span>) <span class="op">+</span></span>
<span id="cb130-2"><a href="generalized-linear-models.html#cb130-2"></a><span class="st">                          </span><span class="kw">ns</span>(time, <span class="dt">df =</span> <span class="dv">158</span>), </span>
<span id="cb130-3"><a href="generalized-linear-models.html#cb130-3"></a>                        <span class="dt">data =</span> obs, <span class="dt">family =</span> <span class="st">&quot;quasipoisson&quot;</span>)</span></code></pre></div>
<p>As when we fit the spline earlier, you can see that this gives us a set of coefficients,
one for each column in the matrix of crossbasis variables:</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb131-1"><a href="generalized-linear-models.html#cb131-1"></a>dlnm_mod_<span class="dv">1</span> <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb131-2"><a href="generalized-linear-models.html#cb131-2"></a><span class="st">  </span><span class="kw">tidy</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb131-3"><a href="generalized-linear-models.html#cb131-3"></a><span class="st">  </span><span class="kw">filter</span>(<span class="kw">str_detect</span>(term, <span class="st">&quot;temp_basis&quot;</span>))</span></code></pre></div>
<pre><code>## # A tibble: 4 x 5
##   term            estimate std.error statistic  p.value
##   &lt;chr&gt;              &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
## 1 temp_basisv1.l1  -0.0700    0.0135    -5.18  2.30e- 7
## 2 temp_basisv2.l1  -0.0660    0.0126    -5.24  1.61e- 7
## 3 temp_basisv3.l1   0.0110    0.0313     0.350 7.26e- 1
## 4 temp_basisv4.l1   0.347     0.0177    19.6   2.02e-83</code></pre>
<p>However, there’s an advantage with using <code>crossbasis</code>, even though it’s looked pretty similar
to using <code>ns</code> up to now. That’s that there are some special functions that let us predict
and visualize the model results without having to do all the work we did before.</p>
<p>For example, there’s a function called <code>crosspred</code> that will give us a number of values,
including the estimated relative risk compared to a reference value. To use this, we
need to input the object name of our crossbasis object (<code>temp_basis</code>) and the name of our
regression model object (<code>dlnm_mod_1</code>). We also want to tell it which temperature we want
to use as our reference (<code>cen = 7</code> to compare everything to 7 degrees C) and what interval
we want for predictions (<code>by = 1</code> will give us an estimate for every degree temperature
along our range). The output is a list with a lot of elements, which you can get a view of
with <code>str</code>:</p>
<div class="sourceCode" id="cb133"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb133-1"><a href="generalized-linear-models.html#cb133-1"></a><span class="kw">crosspred</span>(<span class="dt">basis =</span> temp_basis, <span class="dt">model =</span> dlnm_mod_<span class="dv">1</span>, <span class="dt">cen =</span> <span class="dv">7</span>, <span class="dt">by =</span> <span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb133-2"><a href="generalized-linear-models.html#cb133-2"></a><span class="st">  </span><span class="kw">str</span>()</span></code></pre></div>
<pre><code>## List of 19
##  $ predvar     : num [1:35] -5 -4 -3 -2 -1 0 1 2 3 4 ...
##  $ cen         : num 7
##  $ lag         : num [1:2] 0 0
##  $ bylag       : num 1
##  $ coefficients: Named num [1:4] -0.07 -0.066 0.011 0.347
##   ..- attr(*, &quot;names&quot;)= chr [1:4] &quot;temp_basisv1.l1&quot; &quot;temp_basisv2.l1&quot; &quot;temp_basisv3.l1&quot; &quot;temp_basisv4.l1&quot;
##  $ vcov        : num [1:4, 1:4] 1.83e-04 1.12e-04 3.85e-04 6.58e-05 1.12e-04 ...
##   ..- attr(*, &quot;dimnames&quot;)=List of 2
##   .. ..$ : chr [1:4] &quot;temp_basisv1.l1&quot; &quot;temp_basisv2.l1&quot; &quot;temp_basisv3.l1&quot; &quot;temp_basisv4.l1&quot;
##   .. ..$ : chr [1:4] &quot;temp_basisv1.l1&quot; &quot;temp_basisv2.l1&quot; &quot;temp_basisv3.l1&quot; &quot;temp_basisv4.l1&quot;
##  $ matfit      : num [1:35, 1] 0.0874 0.0756 0.064 0.0529 0.0424 ...
##   ..- attr(*, &quot;dimnames&quot;)=List of 2
##   .. ..$ : chr [1:35] &quot;-5&quot; &quot;-4&quot; &quot;-3&quot; &quot;-2&quot; ...
##   .. ..$ : chr [1, 1] &quot;lag0&quot;
##  $ matse       : num [1:35, 1] 0.01435 0.01254 0.01077 0.00907 0.00746 ...
##   ..- attr(*, &quot;dimnames&quot;)=List of 2
##   .. ..$ : chr [1:35] &quot;-5&quot; &quot;-4&quot; &quot;-3&quot; &quot;-2&quot; ...
##   .. ..$ : chr [1, 1] &quot;lag0&quot;
##  $ allfit      : Named num [1:35] 0.0874 0.0756 0.064 0.0529 0.0424 ...
##   ..- attr(*, &quot;names&quot;)= chr [1:35] &quot;-5&quot; &quot;-4&quot; &quot;-3&quot; &quot;-2&quot; ...
##  $ allse       : Named num [1:35] 0.01435 0.01254 0.01077 0.00907 0.00746 ...
##   ..- attr(*, &quot;names&quot;)= chr [1:35] &quot;-5&quot; &quot;-4&quot; &quot;-3&quot; &quot;-2&quot; ...
##  $ matRRfit    : num [1:35, 1] 1.09 1.08 1.07 1.05 1.04 ...
##   ..- attr(*, &quot;dimnames&quot;)=List of 2
##   .. ..$ : chr [1:35] &quot;-5&quot; &quot;-4&quot; &quot;-3&quot; &quot;-2&quot; ...
##   .. ..$ : chr [1, 1] &quot;lag0&quot;
##  $ matRRlow    : num [1:35, 1] 1.06 1.05 1.04 1.04 1.03 ...
##   ..- attr(*, &quot;dimnames&quot;)=List of 2
##   .. ..$ : chr [1:35] &quot;-5&quot; &quot;-4&quot; &quot;-3&quot; &quot;-2&quot; ...
##   .. ..$ : chr [1, 1] &quot;lag0&quot;
##  $ matRRhigh   : num [1:35, 1] 1.12 1.11 1.09 1.07 1.06 ...
##   ..- attr(*, &quot;dimnames&quot;)=List of 2
##   .. ..$ : chr [1:35] &quot;-5&quot; &quot;-4&quot; &quot;-3&quot; &quot;-2&quot; ...
##   .. ..$ : chr [1, 1] &quot;lag0&quot;
##  $ allRRfit    : Named num [1:35] 1.09 1.08 1.07 1.05 1.04 ...
##   ..- attr(*, &quot;names&quot;)= chr [1:35] &quot;-5&quot; &quot;-4&quot; &quot;-3&quot; &quot;-2&quot; ...
##  $ allRRlow    : Named num [1:35] 1.06 1.05 1.04 1.04 1.03 ...
##   ..- attr(*, &quot;names&quot;)= chr [1:35] &quot;-5&quot; &quot;-4&quot; &quot;-3&quot; &quot;-2&quot; ...
##  $ allRRhigh   : Named num [1:35] 1.12 1.11 1.09 1.07 1.06 ...
##   ..- attr(*, &quot;names&quot;)= chr [1:35] &quot;-5&quot; &quot;-4&quot; &quot;-3&quot; &quot;-2&quot; ...
##  $ ci.level    : num 0.95
##  $ model.class : chr [1:2] &quot;glm&quot; &quot;lm&quot;
##  $ model.link  : chr &quot;log&quot;
##  - attr(*, &quot;class&quot;)= chr &quot;crosspred&quot;</code></pre>
<p>The one we’ll look at right now is <code>allRRfit</code>. You can extract it with (here I’m showing
how you can do it with piping and the <code>pluck</code> function to pull out an element of a list,
but you could do other approaches, too):</p>
<div class="sourceCode" id="cb135"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb135-1"><a href="generalized-linear-models.html#cb135-1"></a>est_rr &lt;-<span class="st"> </span>dlnm_mod_<span class="dv">1</span> <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb135-2"><a href="generalized-linear-models.html#cb135-2"></a><span class="st">  </span><span class="kw">crosspred</span>(<span class="dt">basis =</span> temp_basis, <span class="dt">model =</span> ., <span class="dt">cen =</span> <span class="dv">7</span>, <span class="dt">by =</span> <span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb135-3"><a href="generalized-linear-models.html#cb135-3"></a><span class="st">  </span><span class="kw">pluck</span>(<span class="st">&quot;allRRfit&quot;</span>)</span>
<span id="cb135-4"><a href="generalized-linear-models.html#cb135-4"></a>est_rr</span></code></pre></div>
<pre><code>##        -5        -4        -3        -2        -1         0         1         2 
## 1.0913393 1.0785207 1.0661255 1.0543222 1.0432720 1.0331298 1.0240458 1.0161668 
##         3         4         5         6         7         8         9        10 
## 1.0096382 1.0046057 1.0012180 0.9996288 1.0000000 1.0024680 1.0064490 1.0106777 
##        11        12        13        14        15        16        17        18 
## 1.0138437 1.0147024 1.0135774 1.0122284 1.0124622 1.0160921 1.0245314 1.0378080 
##        19        20        21        22        23        24        25        26 
## 1.0557076 1.0780540 1.1046963 1.1354974 1.1703226 1.2090286 1.2514526 1.2974015 
##        27        28        29 
## 1.3466411 1.3988856 1.4537866</code></pre>
<p>To make it easier to work with, let’s put this in a dataframe. Note that the temperatures
are included as the names in the vector, so we can extract those with <code>names</code>:</p>
<div class="sourceCode" id="cb137"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb137-1"><a href="generalized-linear-models.html#cb137-1"></a>dlnm_temp_function &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">tmean =</span> <span class="kw">as.numeric</span>(<span class="kw">names</span>(est_rr)), </span>
<span id="cb137-2"><a href="generalized-linear-models.html#cb137-2"></a>                             <span class="dt">rr =</span> est_rr)</span>
<span id="cb137-3"><a href="generalized-linear-models.html#cb137-3"></a></span>
<span id="cb137-4"><a href="generalized-linear-models.html#cb137-4"></a>dlnm_temp_function <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb137-5"><a href="generalized-linear-models.html#cb137-5"></a><span class="st">  </span><span class="kw">head</span>()</span></code></pre></div>
<pre><code>## # A tibble: 6 x 2
##   tmean    rr
##   &lt;dbl&gt; &lt;dbl&gt;
## 1    -5  1.09
## 2    -4  1.08
## 3    -3  1.07
## 4    -2  1.05
## 5    -1  1.04
## 6     0  1.03</code></pre>
<p>This has gotten us (much more quickly!) to estimates of the relative risk of mortality at
each temperature compared to a reference of 7 degrees C. We can plot this the same way we
did earlier, and you’ll notice that this plot is identical to the one we created based on the
regression with <code>ns</code> earlier:</p>
<div class="sourceCode" id="cb139"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb139-1"><a href="generalized-linear-models.html#cb139-1"></a><span class="kw">ggplot</span>(dlnm_temp_function, <span class="kw">aes</span>(<span class="dt">x =</span> tmean, <span class="dt">y =</span> rr)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb139-2"><a href="generalized-linear-models.html#cb139-2"></a><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span><span class="st"> </span></span>
<span id="cb139-3"><a href="generalized-linear-models.html#cb139-3"></a><span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span><span class="st"> </span></span>
<span id="cb139-4"><a href="generalized-linear-models.html#cb139-4"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Temperature&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;Relative risk&quot;</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb139-5"><a href="generalized-linear-models.html#cb139-5"></a><span class="st">  </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="fl">1.0</span>, <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>, <span class="dt">linetype =</span> <span class="dv">2</span>)</span></code></pre></div>
<p><img src="adv_epi_analysis_files/figure-html/unnamed-chunk-82-1.png" width="672" /></p>
<p>The <code>dlnm</code> package also includes some functions specifically for plotting. One downside
is that they’re in base R, rather than based on <code>ggplot2</code>, which makes them a bit
harder to customize. However, they’re a great way to get a first look at your results:</p>
<div class="sourceCode" id="cb140"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb140-1"><a href="generalized-linear-models.html#cb140-1"></a>dlnm_mod_<span class="dv">1</span> <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb140-2"><a href="generalized-linear-models.html#cb140-2"></a><span class="st">  </span><span class="kw">crosspred</span>(<span class="dt">basis =</span> temp_basis, <span class="dt">model =</span> ., <span class="dt">cen =</span> <span class="dv">7</span>, <span class="dt">by =</span> <span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb140-3"><a href="generalized-linear-models.html#cb140-3"></a><span class="st">  </span><span class="kw">plot</span>()</span></code></pre></div>
<p><img src="adv_epi_analysis_files/figure-html/unnamed-chunk-83-1.png" width="672" /></p>
<p>Don’t worry if all of this about basis functions is a lot! If this is the first time you’ve
seen this, it will likely take a few passes to get comfortable with it—and while the idea
of basis variables is fairly straightforward, it’s certainly not straightforward to figure
out how to interpret the results of the model that you fit. It is worth the effort, though,
as this is a very powerful tool when working with regression modeling in environmental
epidemiology.</p>
</div>
<div id="distributed-lags-and-cross-basis-functions-in-glms" class="section level2">
<h2><span class="header-section-number">4.3</span> Distributed lags and cross-basis functions in GLMs</h2>
<p>Next, let’s explore how we can add into our model something that lets us look at
delayed effects and the potential for mortality displacement. So far, we have only
considered how temperature affects mortality risk on the day of exposure—in other
words, if it is very hot today, does risk of mortality go up substantially today?
For many exposures, however, risk can persist after the day of exposure.</p>
<p>In some cases, this may be caused by a delay in detection of the outcome in the
data we have. For example, extreme heat today could precipitate a respiratory or
cardiac event that the person may not seek treatment for or result in an outcome
like mortality until tomorrow, and so in the data the outcome would be recorded
at a one-day delay from the exposure.</p>
<p>In other cases, the path from the exposure to the outcome may take several days.
For example, cold temperatures are often found to be associated with respiratory
outcomes a week or more after exposures (something you can look for in the
example data!), and one potential pathway is that cold temperatures might
promote the spread of respiratory infectious disease, like influenza and colds,
both through making people stay inside in more crowded, less ventilated
conditions and also through effects on humidity and other conditions that might
influence the behavior of respiratory droplets, which are key players in
spreading some respiratory diseases. Since there is an incubation time up to
several days for these infectious diseases, we might expect a lagged association
between temperature and respiratory outcomes under this scenario.</p>
<p>There is another lagged pattern that can be important to check for, as well—one
that indicates mortality displacement. For many ambient environmental exposures,
there are clear indications that associations with health outcomes are strongest
among older adults or other populations with a disproportionately high percent
of people who are frail before exposure. One question that comes up, then, is
if, when an exposure is associated with excess deaths, these are deaths that are
displaced in time by only a few days or weeks, rather than deaths that represent
a larger time of life lost. This question—of whether deaths observed to be
associated with an environmental exposure were displaced by only a small amount of
time—can be explored by investigating whether an observed increase in mortality
across a community during an exposure is then offset by a lower-than-expected
rate of mortality in the following days and weeks.This phenomenon is sometimes
also referred to as ‘harvesting’ or a ‘harvesting effect’.</p>
<p>All of these questions can be explored through a type of model called a
<em>distributed lag model</em>. Conceptually, these models investigate how an exposure
today is associated with risk of a health outcome not only today, but also in
the following days. In time-series studies where we typically want to estimate
potential short-term and/or acute effects, and because we are concerned about potential
confounding by seasonal trends—and have incorporated control for these trends in
our models—we often restrict these models to only look up to about a month following
exposure. However, this can help in identifying delayed effects of an exposure days to weeks
following the initial exposure, and can also help in determining the role of
mortality displacement in accounting for some or all of the excess deaths that are
associated with an exposure. While some environmental exposures of interest
have mostly immediate effects (e.g., hot temperature), others, including many air
pollutants, tend to have effects that are stretched over a longer period of one or
more days from exposure. As a result, distributed lag models are used widely in
environmental epidemiology studies of time series data, to ensure that important
associations aren’t missed by limiting the model to focus on risk that are
detectable on the same day as the exposure. They can also help us identify influential
windows of exposure as well as help eliminate potential confounding by exposures
occurring at proximal times to the window of interest. For example, today’s exposure
may appear to have an effect on a health outcome even if in reality yesterday’s
exposure is the influential one and we don’t control for it, because today’s and
yesterday’s exposure to temperature or air pollution are likely to be very similar.</p>
<p>To fit a distributed lag model, you can start with a fairly straightforward
extension of the regression models we’ve been fitting, especially if you are
investigating an exposure that can be plausibly fit with a linear term (rather than
a more complex non-linear basis function) in the regression model. Say you are starting,
for example, from the following regression model:</p>
<p><span class="math display">\[
log(E(Y)) = \alpha + \beta X + \mathbf{\gamma^{&#39;}W} + ns(time)
\]</span></p>
<p>In this model, you are using a Poisson regression to investigate how risk of the
health outcome (<span class="math inline">\(Y\)</span>) changes for every unit increase in the exposure (<span class="math inline">\(X\)</span>), assuming
a linear relationship between the exposure and the log of the health outcome. The model
can include control for confounders like day of week (<span class="math inline">\(\mathbf{W}\)</span>) and long-term and
seasonal time trends (<span class="math inline">\(ns(time)\)</span>). This model should look familiar from some of the
models we’ve fit earlier to the example temperature data.</p>
<p>To expand this model to explore associations of temperature at different lags, the
simplest approach is to add a term for each lag—in other words, instead of only having
a term for temperature on the same day as the outcome measurement, we’ll also include a
term for temperature the previous day, and the day before that, and so on. For example,
here’s what the model would look like if we included terms up to lag 2:</p>
<p><span class="math display">\[
log(E(Y)) = \alpha + \beta_{0} X_{0} + \beta_{1} X_{1} + \beta_{2} X_{2} + \mathbf{\gamma^{&#39;}W} + ns(time)
\]</span>
where <span class="math inline">\(X_0\)</span> is temperature on the same day as the measured outcome <span class="math inline">\(Y\)</span> (with an
associated coefficient <span class="math inline">\(\beta_0\)</span>), <span class="math inline">\(X_1\)</span> is the temperature the day before (with an
associated coefficient <span class="math inline">\(\beta_1\)</span>), and <span class="math inline">\(X_2\)</span> is the temperature two days before (with an
associated coefficient <span class="math inline">\(\beta_2\)</span>). The interpretation of each of these coefficients
is similar—<span class="math inline">\(exp(\beta_2)\)</span>, for example, gives our estimate of the change in the relative
risk of the outcome <span class="math inline">\(Y\)</span> for every one-unit increase in the exposure two days prior.</p>
<p>It can become cumbersome to write out the separate terms for each lag day, so you’ll often
see equations for distributed lag models written using a shorter approach with the
<span class="math inline">\(\sum\)</span> symbol. The <span class="math inline">\(\sum\)</span> symbol expresses several terms that are added together and so
is well-suited for shortening the expression of a distributed lag model. For example, the
previous model equation could be rewritten as:</p>
<p><span class="math display">\[
log(E(Y)) = \alpha + \sum_{l=0}^2{\beta_lX_l} + \mathbf{\gamma^{&#39;}W} + ns(time)
\]</span></p>
<p>This version of a distributed lag model is nice because it is fairly simple—we’re taking the
idea of fitting a linear term for an exposure, and then expanding it to include the
exposure on earlier days by adding the same type of term for exposure measured at each lag.
However, it does have some downsides. The main downside is that exposure
tends to be very strongly correlated from one day to the next. Any time you put different terms in a regression model that are correlated, you create the risk of <em>collinearity</em>, and associated
problems with fitting the model. The term <em>collinearity</em> refers to the idea that you have two or more
columns in your model matrix that give identical (or, if you loosen the definition a bit,
very similar) information. To fit coefficients for each term, the modeling algorithm is trying
to identify weights to place on each column in the model matrix that result in a model that
gives the best likelihood of the data you see. If two or more columns have (almost) identical
information, then the algorithm struggles to determine how to distribute weight across these
two columns. The implications are that you can end up with a lot of instability in model
coefficients for the columns that are collinear, as well as very inflated estimates of the
standard error. Long story short, it can cause problems in your regression model if you include
independent variables that are very strongly correlated with each other, and so we usually
try to avoid doing that.</p>
<p>There are alternative distributed lag models that can help avoid this instability that can
arise from fitting a distributed lag by using a separate term for each lag. All of them share
a common feature—they somehow fit a function of the lags instead of each separate lag, so
that we end up adding fewer terms to the regression model (and, in turn, are somewhat
constraining the pattern that the distributed lag effects follow). At the most extreme,
you can use a function that reduces all the lag terms to a single term, which you can do by
averaging the exposure across all lags. In other words, you could take the same-day
temperature, yesterday’s temperature, and the temperature the day before that, and average
those three temperatures to create the term you put in the model. The model equation
in this case would look like:</p>
<p><span class="math display">\[
log(E(Y)) = \alpha + \beta_{\overline{0-2}} X_{\overline{0-2}} + \mathbf{\gamma^{&#39;}W} + ns(time)
\]</span>
where <span class="math inline">\(\overline{0-2}\)</span> represents an average over lags 0 to 2, and so <span class="math inline">\(X_{\overline{0-2}}\)</span>
is the average of the exposure on lags 0, 1, and 2 compared to the day that <span class="math inline">\(Y\)</span> is
measured.</p>
<p>This approach avoids any issues with collinearity across exposure terms from different
lags, because you’re only including a single term for exposure in the model. However,
there is a downside—this model will provide you with a single estimate for the
lagged effects, without allowing you to explore patterns across lags (for example,
is the association mostly on the day of exposure, or are there some delayed effects on
following days?). Instead, the main assumption is that the effect is constant across
all days in the window of interest.</p>
<p>Another approach is more complex, but it allows you to explore patterns across lags.
Instead of reducing the lagged exposure to a single term in the model, you can reduce
it to a few terms that represent the basis for a smooth function. Often, a polynomial
or natural cubic spline function will be used for this. The details of setting up the
model become more complex, but fortunately there are software packages (like the <code>dlnm</code>
package in R) that help in managing this set-up, as we’ll explore in the exercise.</p>
<p>Packages like <code>dlnm</code> can help in extending the complexity of the distributed lag model
in other ways, too. So far, we have explored using a distributed lag model where we
are happy to model the exposure using a linear term. As we’ve seen in earlier exercises,
this isn’t ideal for temperature. Instead, temperature has a non-linear association
with mortality risk, with the lowest risk at mild temperatures and then increased risk
at both lower (colder) and higher (hotter) temperatures.</p>
<p>We can fit a GLM that incorporates the exposure using a non-linear shape while, at the
same time, including a non-linear function to describe how the association evolves
across lagged time following the exposure. The approach is to extend the idea of
using a basis function—instead of using a basis function in a single dimension, we’ll
use a cross of basis functions in two dimensions. One dimension is the level of exposure
(e.g., cold to hot temperatures), and the other is the timing between the exposure and
the outcome (e.g., same-day to lagged by many days). In terms of the mechanics of
building a model matrix to use to fit the regression model, everything follows directly
from the idea we explored earlier of using a function like a spline to create basis
variables in that model matrix for a term with a non-linear association with the
outcome variable. However, the mechanics do get quite cumbersome as so many terms are
included, and so again we will use the <code>dlnm</code> package to handle these mechanics as we
start to incorporate these cross-basis functions within a GLM.</p>
<p><em>Applied: Including a cross-basis function for exposure-lag-response in a GLM</em></p>
<p>For this exercise, you will continue to build up the model that you began in
the examples in the previous chapter. The example uses the data provided with
one of this chapter’s readings, <span class="citation">Vicedo-Cabrera, Sera, and Gasparrini (<a href="#ref-vicedo2019hands" role="doc-biblioref">2019</a>)</span>.</p>
<ol style="list-style-type: decimal">
<li>Start with the simple model describing how are daily mortality counts are
associated with a linear function of temperature. Include control for day of
week and long-term / seasonal trends. Add to this model a term that describes
the lagged effects of temperature up to a week following exposure, using a
separate model term for each lag. What patterns do you detect in the lagged
effects of temperature?</li>
<li>Start with the model from the first question, but change it to use a smooth
function of lag to detect lagged effects, rather than fitting a seperate term
for each lag. Extend the model to look at lagged effects up to a month following
exposure. What patterns do you see in these lagged effects?</li>
<li>Refine your model to fit for a non-linear, rather than linear, function
of temperature, while also incorporating a function to describe lagged effects up
to a month following exposure. Based on this model, what does the association
between temperature and mortality look like at lag 0 days? How about at lag 21 days?
What does the pattern of lagged effects look like when comparing the relative risk of
mortality at a hot temperature (e.g., 28 degrees C) to a milder temperature
(7 degrees C)? What about when comparing mortality at a cold temperature
(e.g., -4 degrees C) to a milder temperature (7 degrees C)? If you use a constant
term for the effect of exposure
over a month as opposed to the smooth function you just used, how does the overall
cumulative RR compare?</li>
<li>Assume that we are interested in the potential effect of a 5-day
heatwave occurring on lags 0 to 4? You can assess this as the effect of hot temperature
(e.g., 28 degrees C) during these lags, while the temperature remains warm but more
mild (e.g., 20 degrees C) the rest of the month, against constant 20 degrees C for
the whole month. What is the effect under the ‘constant’ model? How about the smooth
function lag model?</li>
</ol>
<p><em>Applied exercise: Example code</em></p>
<ol style="list-style-type: decimal">
<li><strong>Start with the simple model describing how are daily mortality counts are
associated with a linear function of temperature. Include control for day of
week and long-term / seasonal trends. Add to this model a term that describes
the lagged effects of temperature up to a week following exposure, using a
separate model term for each lag. What patterns do you detect in the lagged
effects of temperature?</strong></li>
</ol>
<p>We’ll start by looking at distributed lag associations by fitting a model with
separate terms for each of the lags we want to fit. Here, we want to fit up to
a week, so we’ll want eight terms in total: ones for the same day (<span class="math inline">\(X_0\)</span>), the
previous day (<span class="math inline">\(X_1\)</span>), two days before (<span class="math inline">\(X_2\)</span>), three days before (<span class="math inline">\(X_3\)</span>),
four days before (<span class="math inline">\(X_4\)</span>), five days before (<span class="math inline">\(X_5\)</span>), six days before (<span class="math inline">\(X_6\)</span>),
and seven days before (<span class="math inline">\(X_7\)</span>).</p>
<p>Right now, our data have temperature lined up with the date of the recorded deaths:</p>
<div class="sourceCode" id="cb141"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb141-1"><a href="generalized-linear-models.html#cb141-1"></a>obs <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb141-2"><a href="generalized-linear-models.html#cb141-2"></a><span class="st">  </span><span class="kw">select</span>(date, all, tmean) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb141-3"><a href="generalized-linear-models.html#cb141-3"></a><span class="st">  </span><span class="kw">head</span>()</span></code></pre></div>
<pre><code>## # A tibble: 6 x 3
##   date         all tmean
##   &lt;date&gt;     &lt;dbl&gt; &lt;dbl&gt;
## 1 1990-01-01   220  3.91
## 2 1990-01-02   257  5.55
## 3 1990-01-03   245  4.39
## 4 1990-01-04   226  5.43
## 5 1990-01-05   236  6.87
## 6 1990-01-06   235  9.23</code></pre>
<p>To add lagged temperature to the model, then, we’ll need to add some columns to our
data, so that the row for an observation includes not only the temperature on that
day, but also on each of the seven previous days. The <code>lag</code> function from the <code>tidyverse</code>
suite of packages can be used to create these columns:</p>
<div class="sourceCode" id="cb143"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb143-1"><a href="generalized-linear-models.html#cb143-1"></a>obs &lt;-<span class="st"> </span>obs <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb143-2"><a href="generalized-linear-models.html#cb143-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">tmean_1 =</span> <span class="kw">lag</span>(tmean, <span class="dt">n =</span> <span class="dv">1</span>), </span>
<span id="cb143-3"><a href="generalized-linear-models.html#cb143-3"></a>         <span class="dt">tmean_2 =</span> <span class="kw">lag</span>(tmean, <span class="dt">n =</span> <span class="dv">2</span>), </span>
<span id="cb143-4"><a href="generalized-linear-models.html#cb143-4"></a>         <span class="dt">tmean_3 =</span> <span class="kw">lag</span>(tmean, <span class="dt">n =</span> <span class="dv">3</span>), </span>
<span id="cb143-5"><a href="generalized-linear-models.html#cb143-5"></a>         <span class="dt">tmean_4 =</span> <span class="kw">lag</span>(tmean, <span class="dt">n =</span> <span class="dv">4</span>), </span>
<span id="cb143-6"><a href="generalized-linear-models.html#cb143-6"></a>         <span class="dt">tmean_5 =</span> <span class="kw">lag</span>(tmean, <span class="dt">n =</span> <span class="dv">5</span>), </span>
<span id="cb143-7"><a href="generalized-linear-models.html#cb143-7"></a>         <span class="dt">tmean_6 =</span> <span class="kw">lag</span>(tmean, <span class="dt">n =</span> <span class="dv">6</span>), </span>
<span id="cb143-8"><a href="generalized-linear-models.html#cb143-8"></a>         <span class="dt">tmean_7 =</span> <span class="kw">lag</span>(tmean, <span class="dt">n =</span> <span class="dv">7</span>))</span></code></pre></div>
<p>You can see below that each of these have taken <code>tmean</code> and then offset it by moving it down
by one or more rows (down one row for lag 1, two for lag 2, etc.). As a result, we now have
columns that give us today’s temperature, yesterday’s, and so on, all lined up with the
row with the observation for daily mortality:</p>
<div class="sourceCode" id="cb144"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb144-1"><a href="generalized-linear-models.html#cb144-1"></a>obs <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb144-2"><a href="generalized-linear-models.html#cb144-2"></a><span class="st">  </span><span class="kw">select</span>(date, all, tmean, tmean_<span class="dv">1</span><span class="op">:</span>tmean_<span class="dv">7</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb144-3"><a href="generalized-linear-models.html#cb144-3"></a><span class="st">  </span><span class="kw">head</span>()</span></code></pre></div>
<pre><code>## # A tibble: 6 x 10
##   date         all tmean tmean_1 tmean_2 tmean_3 tmean_4 tmean_5 tmean_6 tmean_7
##   &lt;date&gt;     &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
## 1 1990-01-01   220  3.91   NA      NA      NA      NA      NA         NA      NA
## 2 1990-01-02   257  5.55    3.91   NA      NA      NA      NA         NA      NA
## 3 1990-01-03   245  4.39    5.55    3.91   NA      NA      NA         NA      NA
## 4 1990-01-04   226  5.43    4.39    5.55    3.91   NA      NA         NA      NA
## 5 1990-01-05   236  6.87    5.43    4.39    5.55    3.91   NA         NA      NA
## 6 1990-01-06   235  9.23    6.87    5.43    4.39    5.55    3.91      NA      NA</code></pre>
<p>You’ll notice that this process has created some missing data right at the beginning of the
dataset—we don’t know what the temperature was the day before Jan. 1, 1990, for example,
since the study data starts on Jan. 1, 1990. With most time series, we’ll have plenty of
days in the study period, so we’ll usually just allow these early dates to drop when the
model is fit.</p>
<p>Now we’ll add all these terms to our regression model:</p>
<div class="sourceCode" id="cb146"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb146-1"><a href="generalized-linear-models.html#cb146-1"></a>dist_lag_mod_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw">glm</span>(all <span class="op">~</span><span class="st"> </span>tmean <span class="op">+</span><span class="st"> </span>tmean_<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>tmean_<span class="dv">2</span> <span class="op">+</span><span class="st"> </span>tmean_<span class="dv">3</span> <span class="op">+</span><span class="st"> </span>tmean_<span class="dv">4</span> <span class="op">+</span><span class="st"> </span></span>
<span id="cb146-2"><a href="generalized-linear-models.html#cb146-2"></a><span class="st">                        </span>tmean_<span class="dv">5</span> <span class="op">+</span><span class="st"> </span>tmean_<span class="dv">6</span> <span class="op">+</span><span class="st"> </span>tmean_<span class="dv">7</span> <span class="op">+</span><span class="st"> </span></span>
<span id="cb146-3"><a href="generalized-linear-models.html#cb146-3"></a><span class="st">                        </span><span class="kw">factor</span>(dow, <span class="dt">ordered =</span> <span class="ot">FALSE</span>) <span class="op">+</span></span>
<span id="cb146-4"><a href="generalized-linear-models.html#cb146-4"></a><span class="st">                          </span><span class="kw">ns</span>(time, <span class="dt">df =</span> <span class="dv">158</span>), </span>
<span id="cb146-5"><a href="generalized-linear-models.html#cb146-5"></a>                        <span class="dt">data =</span> obs, <span class="dt">family =</span> <span class="st">&quot;quasipoisson&quot;</span>)</span></code></pre></div>
<p>If you look at the output from the model, you can see that a regression coefficient has been
fit for each of these distributed lag terms:</p>
<div class="sourceCode" id="cb147"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb147-1"><a href="generalized-linear-models.html#cb147-1"></a>dist_lag_mod_<span class="dv">1</span> <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb147-2"><a href="generalized-linear-models.html#cb147-2"></a><span class="st">  </span><span class="kw">tidy</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb147-3"><a href="generalized-linear-models.html#cb147-3"></a><span class="st">  </span><span class="kw">filter</span>(<span class="kw">str_detect</span>(term, <span class="st">&quot;tmean&quot;</span>))</span></code></pre></div>
<pre><code>## # A tibble: 8 x 5
##   term     estimate std.error statistic  p.value
##   &lt;chr&gt;       &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
## 1 tmean    0.00749   0.000592    12.6   2.67e-36
## 2 tmean_1 -0.00255   0.000788    -3.23  1.25e- 3
## 3 tmean_2 -0.00152   0.000797    -1.91  5.68e- 2
## 4 tmean_3 -0.00243   0.000798    -3.05  2.31e- 3
## 5 tmean_4 -0.00106   0.000798    -1.32  1.86e- 1
## 6 tmean_5 -0.000515  0.000797    -0.645 5.19e- 1
## 7 tmean_6 -0.00107   0.000789    -1.36  1.73e- 1
## 8 tmean_7 -0.00209   0.000593    -3.52  4.30e- 4</code></pre>
<p>We can pull out all those estimates, calculate the 95% confidence intervals (do this <em>before</em>
you take the exponential to get to the relative risk estimate, not after!), and then
exponentiate all the terms to get estimates of relative risk of mortality per unit increase
in temperature.</p>
<div class="sourceCode" id="cb149"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb149-1"><a href="generalized-linear-models.html#cb149-1"></a>dist_lag_terms &lt;-<span class="st"> </span>dist_lag_mod_<span class="dv">1</span> <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb149-2"><a href="generalized-linear-models.html#cb149-2"></a><span class="st">  </span><span class="kw">tidy</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb149-3"><a href="generalized-linear-models.html#cb149-3"></a><span class="st">  </span><span class="kw">filter</span>(<span class="kw">str_detect</span>(term, <span class="st">&quot;tmean&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb149-4"><a href="generalized-linear-models.html#cb149-4"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">lag =</span> <span class="dv">0</span><span class="op">:</span><span class="dv">7</span>, </span>
<span id="cb149-5"><a href="generalized-linear-models.html#cb149-5"></a>         <span class="dt">low_ci =</span> estimate <span class="op">-</span><span class="st"> </span><span class="fl">1.96</span> <span class="op">*</span><span class="st"> </span>std.error, </span>
<span id="cb149-6"><a href="generalized-linear-models.html#cb149-6"></a>         <span class="dt">high_ci =</span> estimate <span class="op">+</span><span class="st"> </span><span class="fl">1.96</span> <span class="op">*</span><span class="st"> </span>std.error, </span>
<span id="cb149-7"><a href="generalized-linear-models.html#cb149-7"></a>         <span class="dt">rr =</span> <span class="kw">exp</span>(estimate), </span>
<span id="cb149-8"><a href="generalized-linear-models.html#cb149-8"></a>         <span class="dt">low_rr =</span> <span class="kw">exp</span>(low_ci), </span>
<span id="cb149-9"><a href="generalized-linear-models.html#cb149-9"></a>         <span class="dt">high_rr =</span> <span class="kw">exp</span>(high_ci)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb149-10"><a href="generalized-linear-models.html#cb149-10"></a><span class="st">  </span><span class="kw">select</span>(term, lag, rr, low_rr, high_rr)</span>
<span id="cb149-11"><a href="generalized-linear-models.html#cb149-11"></a>dist_lag_terms</span></code></pre></div>
<pre><code>## # A tibble: 8 x 5
##   term      lag    rr low_rr high_rr
##   &lt;chr&gt;   &lt;int&gt; &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;
## 1 tmean       0 1.01   1.01    1.01 
## 2 tmean_1     1 0.997  0.996   0.999
## 3 tmean_2     2 0.998  0.997   1.00 
## 4 tmean_3     3 0.998  0.996   0.999
## 5 tmean_4     4 0.999  0.997   1.00 
## 6 tmean_5     5 0.999  0.998   1.00 
## 7 tmean_6     6 0.999  0.997   1.00 
## 8 tmean_7     7 0.998  0.997   0.999</code></pre>
<p>You can plot these estimates to explore how the association changes by lag (notice how
<code>geom_pointrange</code> is very helpful here!):</p>
<div class="sourceCode" id="cb151"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb151-1"><a href="generalized-linear-models.html#cb151-1"></a>dist_lag_terms <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb151-2"><a href="generalized-linear-models.html#cb151-2"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> lag, <span class="dt">y =</span> rr)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb151-3"><a href="generalized-linear-models.html#cb151-3"></a><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span><span class="st"> </span></span>
<span id="cb151-4"><a href="generalized-linear-models.html#cb151-4"></a><span class="st">  </span><span class="kw">geom_pointrange</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> low_rr, <span class="dt">ymax =</span> high_rr)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb151-5"><a href="generalized-linear-models.html#cb151-5"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Lag days since exposure&quot;</span>, </span>
<span id="cb151-6"><a href="generalized-linear-models.html#cb151-6"></a>       <span class="dt">y =</span> <span class="st">&quot;Relative risk of mortality</span><span class="ch">\n</span><span class="st">per degree increase in temperature&quot;</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb151-7"><a href="generalized-linear-models.html#cb151-7"></a><span class="st">  </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="dv">1</span>, <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>, <span class="dt">linetype =</span> <span class="dv">3</span>)</span></code></pre></div>
<p><img src="adv_epi_analysis_files/figure-html/unnamed-chunk-90-1.png" width="672" /></p>
<p>You can also, as an alternative, use the <code>dlnm</code> package to fit this
model, using the <code>crossbasis</code> function
to set up the distributed lag basis to include in the regression, and then the <code>crosspred</code>
function to extract results after fitting the regression model and to plot results.</p>
<p>First, you’ll again use <code>crossbasis</code> to create the basis, as you did earlier when using this
package to fit a non-linear function of temperature. You will use the <code>lag</code> argument to say
the maximum lag you want to include—in this case, seven days (<code>lag = 7</code>). You can use
the <code>argvar</code> and <code>arglag</code> functions to specify the basis function for the exposure variable
and the distributed lag component. For right now, we’ll use a very basic linear function for
the exposure (temperature), using <code>fun = "lin"</code> within the <code>argvar</code> list of arguments.
To fit a separate coefficient for each lag, we can specify <code>fun = "integer"</code> in the
<code>arglag</code> list of arguments (later we’ll explore some other functions for the lag component).</p>
<div class="sourceCode" id="cb152"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb152-1"><a href="generalized-linear-models.html#cb152-1"></a><span class="kw">library</span>(dlnm)</span>
<span id="cb152-2"><a href="generalized-linear-models.html#cb152-2"></a>dl_basis &lt;-<span class="st"> </span><span class="kw">crossbasis</span>(obs<span class="op">$</span>tmean, <span class="dt">lag =</span> <span class="dv">7</span>,</span>
<span id="cb152-3"><a href="generalized-linear-models.html#cb152-3"></a>                       <span class="dt">argvar =</span> <span class="kw">list</span>(<span class="dt">fun =</span> <span class="st">&quot;lin&quot;</span>), </span>
<span id="cb152-4"><a href="generalized-linear-models.html#cb152-4"></a>                       <span class="dt">arglag =</span> <span class="kw">list</span>(<span class="dt">fun =</span> <span class="st">&quot;integer&quot;</span>))</span></code></pre></div>
<p>If you take a peak at this crossbasis, you’ll notice that it’s doing something similar to
what we did when we added columns for lagged temperatures. The first column gives temperature
on the same day, the second on the previous day (and so is offset one down from the first
column), and so on. The crossbasis function deals with the missing early dates by setting
<em>all</em> column values to be missing on those days; in practice, this difference in set up
won’t create any difference in how the model is fit, as the <code>glm</code> function will by default
exclude any observations with <em>any</em> columns of missing data.</p>
<div class="sourceCode" id="cb153"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb153-1"><a href="generalized-linear-models.html#cb153-1"></a>dl_basis <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb153-2"><a href="generalized-linear-models.html#cb153-2"></a><span class="st">  </span><span class="kw">head</span>(<span class="dt">n =</span> <span class="dv">12</span>)</span></code></pre></div>
<pre><code>##           v1.l1     v1.l2    v1.l3    v1.l4    v1.l5    v1.l6    v1.l7    v1.l8
##  [1,]        NA        NA       NA       NA       NA       NA       NA       NA
##  [2,]        NA        NA       NA       NA       NA       NA       NA       NA
##  [3,]        NA        NA       NA       NA       NA       NA       NA       NA
##  [4,]        NA        NA       NA       NA       NA       NA       NA       NA
##  [5,]        NA        NA       NA       NA       NA       NA       NA       NA
##  [6,]        NA        NA       NA       NA       NA       NA       NA       NA
##  [7,]        NA        NA       NA       NA       NA       NA       NA       NA
##  [8,]  7.958644  6.686216 9.232628 6.867855 5.431046 4.385564 5.547919 3.913589
##  [9,]  7.268950  7.958644 6.686216 9.232628 6.867855 5.431046 4.385564 5.547919
## [10,]  9.510644  7.268950 7.958644 6.686216 9.232628 6.867855 5.431046 4.385564
## [11,] 10.424808  9.510644 7.268950 7.958644 6.686216 9.232628 6.867855 5.431046
## [12,]  7.368595 10.424808 9.510644 7.268950 7.958644 6.686216 9.232628 6.867855</code></pre>
<p>We can use this matrix of crossbasis variables now in our regression call:</p>
<div class="sourceCode" id="cb155"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb155-1"><a href="generalized-linear-models.html#cb155-1"></a>dist_lag_mod_<span class="dv">2</span> &lt;-<span class="st"> </span><span class="kw">glm</span>(all <span class="op">~</span><span class="st"> </span>dl_basis <span class="op">+</span><span class="st"> </span></span>
<span id="cb155-2"><a href="generalized-linear-models.html#cb155-2"></a><span class="st">                        </span><span class="kw">factor</span>(dow, <span class="dt">ordered =</span> <span class="ot">FALSE</span>) <span class="op">+</span></span>
<span id="cb155-3"><a href="generalized-linear-models.html#cb155-3"></a><span class="st">                          </span><span class="kw">ns</span>(time, <span class="dt">df =</span> <span class="dv">158</span>), </span>
<span id="cb155-4"><a href="generalized-linear-models.html#cb155-4"></a>                        <span class="dt">data =</span> obs, <span class="dt">family =</span> <span class="st">&quot;quasipoisson&quot;</span>)</span></code></pre></div>
<p>Again, you can pull the regression coefficients directly out of the regression model object
(and you can see how they’re identical to those from our first distributed lag model):</p>
<div class="sourceCode" id="cb156"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb156-1"><a href="generalized-linear-models.html#cb156-1"></a>dist_lag_mod_<span class="dv">2</span> <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb156-2"><a href="generalized-linear-models.html#cb156-2"></a><span class="st">  </span><span class="kw">tidy</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb156-3"><a href="generalized-linear-models.html#cb156-3"></a><span class="st">  </span><span class="kw">filter</span>(<span class="kw">str_detect</span>(term, <span class="st">&quot;dl_basis&quot;</span>))</span></code></pre></div>
<pre><code>## # A tibble: 8 x 5
##   term           estimate std.error statistic  p.value
##   &lt;chr&gt;             &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
## 1 dl_basisv1.l1  0.00749   0.000592    12.6   2.67e-36
## 2 dl_basisv1.l2 -0.00255   0.000788    -3.23  1.25e- 3
## 3 dl_basisv1.l3 -0.00152   0.000797    -1.91  5.68e- 2
## 4 dl_basisv1.l4 -0.00243   0.000798    -3.05  2.31e- 3
## 5 dl_basisv1.l5 -0.00106   0.000798    -1.32  1.86e- 1
## 6 dl_basisv1.l6 -0.000515  0.000797    -0.645 5.19e- 1
## 7 dl_basisv1.l7 -0.00107   0.000789    -1.36  1.73e- 1
## 8 dl_basisv1.l8 -0.00209   0.000593    -3.52  4.30e- 4</code></pre>
<p>You can proceed from here to plot estimates by lag using ggplot, but you can also use
some of the special functions for plotting in <code>dlnm</code>. We can plot the “slice” of comparing
the relative risk at 1 degree C (<code>var = 1</code>) (this will give us the one-unit increase,
because by default the crossbasis set-up with 0 degrees as the baseline, so this is
one degree above that value). The <code>crosspred</code> function predicts based on two things: (1)
a crossbasis and (2) a regression model object that uses that crossbasis. Once you create
an object with <code>crosspred</code>, then the <code>plot</code> function has a
special method for plotting that object (to see the helpfile for this
plot method, type <code>?plot.crosspred</code> in your R console).</p>
<div class="sourceCode" id="cb158"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb158-1"><a href="generalized-linear-models.html#cb158-1"></a><span class="kw">crosspred</span>(dl_basis, dist_lag_mod_<span class="dv">2</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb158-2"><a href="generalized-linear-models.html#cb158-2"></a><span class="st">  </span><span class="kw">plot</span>(<span class="dt">ptype =</span> <span class="st">&quot;slices&quot;</span>, <span class="dt">var =</span> <span class="dv">1</span>, <span class="dt">ci =</span> <span class="st">&quot;bars&quot;</span>)</span></code></pre></div>
<p><img src="adv_epi_analysis_files/figure-html/unnamed-chunk-95-1.png" width="672" /></p>
<p>However, even though mechanically we can fit this model, we should think about whether
it’s a good idea, or whether we should contrain the lag function some.
If you look at the correlations between temperature at different lags, you’ll see they are very
strongly correlated:</p>
<div class="sourceCode" id="cb159"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb159-1"><a href="generalized-linear-models.html#cb159-1"></a>obs <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb159-2"><a href="generalized-linear-models.html#cb159-2"></a><span class="st">  </span><span class="kw">select</span>(tmean, tmean_<span class="dv">1</span><span class="op">:</span>tmean_<span class="dv">7</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb159-3"><a href="generalized-linear-models.html#cb159-3"></a><span class="st">  </span><span class="kw">cor</span>(<span class="dt">use =</span> <span class="st">&quot;complete.obs&quot;</span>) </span></code></pre></div>
<pre><code>##             tmean   tmean_1   tmean_2   tmean_3   tmean_4   tmean_5   tmean_6
## tmean   1.0000000 0.9431416 0.8845767 0.8462589 0.8215974 0.8031790 0.7891306
## tmean_1 0.9431416 1.0000000 0.9431447 0.8846236 0.8463419 0.8216464 0.8032469
## tmean_2 0.8845767 0.9431447 1.0000000 0.9431403 0.8846198 0.8463094 0.8216348
## tmean_3 0.8462589 0.8846236 0.9431403 1.0000000 0.9431414 0.8846132 0.8463072
## tmean_4 0.8215974 0.8463419 0.8846198 0.9431414 1.0000000 0.9431482 0.8846132
## tmean_5 0.8031790 0.8216464 0.8463094 0.8846132 0.9431482 1.0000000 0.9431506
## tmean_6 0.7891306 0.8032469 0.8216348 0.8463072 0.8846132 0.9431506 1.0000000
## tmean_7 0.7781337 0.7892093 0.8032205 0.8216271 0.8463046 0.8846283 0.9431482
##           tmean_7
## tmean   0.7781337
## tmean_1 0.7892093
## tmean_2 0.8032205
## tmean_3 0.8216271
## tmean_4 0.8463046
## tmean_5 0.8846283
## tmean_6 0.9431482
## tmean_7 1.0000000</code></pre>
<p>This means that we could have some issues with collinearity if we
use this simpler distributed lag model, with a separate coefficient for each lag
Next, we’ll explore a model that constrains the lagged effects to follow a smooth
function, to help avoid this potential instability in the modeling.</p>
<ol start="2" style="list-style-type: decimal">
<li><strong>Start with the model from the first question, but change it to use a smooth
function of lag to detect lagged effects, rather than fitting a separate term
for each lag. Extend the model to look at lagged effects up to a month following
exposure. What patterns do you see in these lagged effects?</strong></li>
</ol>
<p>As a reminder, we can stabilize our model of lagged effects a bit by fitting the
lagged effects to be constrained to follow a smooth function, instead of fitting a separate
term for each lag. The <code>dlnm</code> package makes this very easy to do.</p>
<p>When you use <code>crossbasis</code> to set up a crossbasis function, you can make a lot of choices
to customize that crossbasis. The crossbasis combines a basis function for incorporating
the exposure in the regression model (temperature in this case), as well as a basis function
for incorporating lagged effects of that exposure. The <code>crossbasis</code> functions gives you
several choices for each of these basis functions for the two dimensions of the
crossbasis. Here, we’ll look at using that flexibility for the lag dimension; in the next
part of the exercise, we’ll add some more complexity in the basis function for the
exposure, as well.</p>
<p>To customize the basis function for lagged effects, you can use the <code>arglag</code> parameter
in the <code>crossbasis</code> function. You send this parameter a list of other parameters, which
get sent to a general <code>onebasis</code> function that builds that basis function (this will
be convenient when we start working with the exposure basis, too—you’ll see that you
can use the same parameters in setting up each basis function).</p>
<p>To see the range of functions you can use for this crossbasis function, check the help
function for <code>onebasis</code>. When we fit a separate coefficient for each lag, we used the
“integer” function, which creates a set of basis variables with indicators for each
separate lag (this is really similar to the idea of basis variables for a categorical
variable, like day of the week). This is what we did in the first part of the exercise.</p>
<p>Now, we want to instead use a smooth function, with fewer degrees of freedom (i.e., fewer
columns created in the matrix of basis values). Two popular options for that function are
the “poly” function, which will fit a polynomial, or the “ns” function, which will fit
a natural cubic spline (just like we did earlier to create a non-linear function of
temperature). We’ll use “ns” in this example (<code>fun = "ns"</code> in the list of parameters for
<code>arglag</code>).</p>
<p>For some of these functions, you’ll need to specify additional parameters to clarify
how they should be built. For example, if you’re using a spline, you need to specify
how many degrees of freedom it should have with <code>df</code>. We’ll use 4 degrees of freedom,
but you can experiment with different values for this and see how it affects the shape
of the resulting function (i.e., the plot we create later). If you were fitting a
polynomial function,
you’d need to specify the degree of the polynomial; if you were fitting strata (i.e.,
constant values within sets of lags), you’d need to specify the breaks for dividing
those strata; if you were using a threshold function, you’d need to specify the threshold,
and so on. You can find more details on these options in the helpfile for <code>onebasis</code>;
in general, the <code>onebasis</code> function is using other underlying functions like <code>ns</code> and
<code>poly</code> to build these functions, so the choice of parameters will depend on the parameters
for those underlying functions.</p>
<p>Here is the final call for building this new crossbasis (note that we’re continuing to
use a linear function of temperature, and at this point still only looking at lags up to
a week; later in this question we’ll expand to look at longer lags):</p>
<div class="sourceCode" id="cb161"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb161-1"><a href="generalized-linear-models.html#cb161-1"></a>dl_basis_<span class="dv">2</span> &lt;-<span class="st"> </span><span class="kw">crossbasis</span>(obs<span class="op">$</span>tmean, <span class="dt">lag =</span> <span class="dv">7</span>,</span>
<span id="cb161-2"><a href="generalized-linear-models.html#cb161-2"></a>                       <span class="dt">argvar =</span> <span class="kw">list</span>(<span class="dt">fun =</span> <span class="st">&quot;lin&quot;</span>), </span>
<span id="cb161-3"><a href="generalized-linear-models.html#cb161-3"></a>                       <span class="dt">arglag =</span> <span class="kw">list</span>(<span class="dt">fun =</span> <span class="st">&quot;ns&quot;</span>, <span class="dt">df =</span> <span class="dv">4</span>))</span></code></pre></div>
<p>If you look at this crossbasis object, you’ll see that it’s created a matrix of basis
variables, similar to the last part of the exercise. However, instead of having the same
number of columns as the number of lags (8), we now have fewer columns. We have 4, reflecting
the degrees of freedom we specified for the spline function of lag. Therefore, we’ve
constrained the lag function a bit compared to the previous part of the exercise. Again,
the values are all missing for the first seven days, since the data isn’t able to capture
the lagged temperature for these days.</p>
<div class="sourceCode" id="cb162"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb162-1"><a href="generalized-linear-models.html#cb162-1"></a>dl_basis_<span class="dv">2</span> <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb162-2"><a href="generalized-linear-models.html#cb162-2"></a><span class="st">  </span><span class="kw">head</span>(<span class="dt">n =</span> <span class="dv">12</span>)</span></code></pre></div>
<pre><code>##          v1.l1    v1.l2    v1.l3      v1.l4
##  [1,]       NA       NA       NA         NA
##  [2,]       NA       NA       NA         NA
##  [3,]       NA       NA       NA         NA
##  [4,]       NA       NA       NA         NA
##  [5,]       NA       NA       NA         NA
##  [6,]       NA       NA       NA         NA
##  [7,]       NA       NA       NA         NA
##  [8,] 10.53142 5.938107 17.26767 -2.9117904
##  [9,] 11.46186 7.311815 17.99659 -2.0873124
## [10,] 10.91751 8.769682 19.69413 -3.2804334
## [11,] 10.94122 8.867758 22.33138 -2.7169313
## [12,] 13.00391 8.984807 22.20899 -0.3726342</code></pre>
<p>Again, once we build the crossbasis function, we can put it in the regression equation and
fit a regression model using <code>glm</code>:</p>
<div class="sourceCode" id="cb164"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb164-1"><a href="generalized-linear-models.html#cb164-1"></a>dist_lag_mod_<span class="dv">3</span> &lt;-<span class="st"> </span><span class="kw">glm</span>(all <span class="op">~</span><span class="st"> </span>dl_basis_<span class="dv">2</span> <span class="op">+</span><span class="st"> </span></span>
<span id="cb164-2"><a href="generalized-linear-models.html#cb164-2"></a><span class="st">                        </span><span class="kw">factor</span>(dow, <span class="dt">ordered =</span> <span class="ot">FALSE</span>) <span class="op">+</span></span>
<span id="cb164-3"><a href="generalized-linear-models.html#cb164-3"></a><span class="st">                          </span><span class="kw">ns</span>(time, <span class="dt">df =</span> <span class="dv">158</span>), </span>
<span id="cb164-4"><a href="generalized-linear-models.html#cb164-4"></a>                        <span class="dt">data =</span> obs, <span class="dt">family =</span> <span class="st">&quot;quasipoisson&quot;</span>)</span></code></pre></div>
<p>Again, you can plot the results to see the pattern of associations by lag. The plot
is just visualizing the results of predicting the model to certain values. By default,
it will predict at each lag; this makes the plot a little “jumpy” if you’re just looking
at lags for a week or so, so to make it smoother, you might want to ask <code>crosspred</code> to
predict to a finer resolution along the lag dimension (here, we’re using <code>bylag = 0.2</code>).</p>
<div class="sourceCode" id="cb165"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb165-1"><a href="generalized-linear-models.html#cb165-1"></a><span class="kw">crosspred</span>(dl_basis_<span class="dv">2</span>, dist_lag_mod_<span class="dv">3</span>, <span class="dt">at =</span> <span class="dv">1</span>, <span class="dt">bylag =</span> <span class="fl">0.2</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb165-2"><a href="generalized-linear-models.html#cb165-2"></a><span class="st">  </span><span class="kw">plot</span>(<span class="dt">ptype =</span> <span class="st">&quot;slices&quot;</span>, <span class="dt">var =</span> <span class="dv">1</span>)</span></code></pre></div>
<p><img src="adv_epi_analysis_files/figure-html/unnamed-chunk-100-1.png" width="672" /></p>
<p>You can go back to the <code>crossbasis</code> call and try playing around with the degrees of freedom
for the spline, to see how that affects the shape of this function. Be sure, though, that
you don’t use more degrees of freedom than there are lags (i.e., more than 8).</p>
<p>Now let’s try to extend the model out to look at up to a month after exposure. To do this,
all you need to do is change the <code>lag</code> argument in <code>crossbasis</code> to the longest lag you
want to include. Since we’re adding more lags, you’ll likely also want to increase the
degrees of freedom you use for the basis function of lag; here, I’m using 6, but you can
explore other values as well (again, don’t use more than the number of lags, though).
From there, the process of fitting the model and plotting the results is identical.</p>
<div class="sourceCode" id="cb166"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb166-1"><a href="generalized-linear-models.html#cb166-1"></a>dl_basis_<span class="dv">3</span> &lt;-<span class="st"> </span><span class="kw">crossbasis</span>(obs<span class="op">$</span>tmean, <span class="dt">lag =</span> <span class="dv">30</span>,</span>
<span id="cb166-2"><a href="generalized-linear-models.html#cb166-2"></a>                       <span class="dt">argvar =</span> <span class="kw">list</span>(<span class="dt">fun =</span> <span class="st">&quot;lin&quot;</span>), </span>
<span id="cb166-3"><a href="generalized-linear-models.html#cb166-3"></a>                       <span class="dt">arglag =</span> <span class="kw">list</span>(<span class="dt">fun =</span> <span class="st">&quot;ns&quot;</span>, <span class="dt">df =</span> <span class="dv">6</span>))</span>
<span id="cb166-4"><a href="generalized-linear-models.html#cb166-4"></a>dist_lag_mod_<span class="dv">4</span> &lt;-<span class="st"> </span><span class="kw">glm</span>(all <span class="op">~</span><span class="st"> </span>dl_basis_<span class="dv">3</span> <span class="op">+</span><span class="st"> </span></span>
<span id="cb166-5"><a href="generalized-linear-models.html#cb166-5"></a><span class="st">                        </span><span class="kw">factor</span>(dow, <span class="dt">ordered =</span> <span class="ot">FALSE</span>) <span class="op">+</span></span>
<span id="cb166-6"><a href="generalized-linear-models.html#cb166-6"></a><span class="st">                          </span><span class="kw">ns</span>(time, <span class="dt">df =</span> <span class="dv">158</span>), </span>
<span id="cb166-7"><a href="generalized-linear-models.html#cb166-7"></a>                        <span class="dt">data =</span> obs, <span class="dt">family =</span> <span class="st">&quot;quasipoisson&quot;</span>)</span>
<span id="cb166-8"><a href="generalized-linear-models.html#cb166-8"></a><span class="kw">crosspred</span>(dl_basis_<span class="dv">3</span>, dist_lag_mod_<span class="dv">4</span>, <span class="dt">at =</span> <span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb166-9"><a href="generalized-linear-models.html#cb166-9"></a><span class="st">  </span><span class="kw">plot</span>(<span class="dt">ptype =</span> <span class="st">&quot;slices&quot;</span>, <span class="dt">var =</span> <span class="dv">1</span>)</span></code></pre></div>
<p><img src="adv_epi_analysis_files/figure-html/unnamed-chunk-101-1.png" width="672" /></p>
<ol start="3" style="list-style-type: decimal">
<li><strong>Refine your model to fit for a non-linear, rather than linear, function
of temperature, while also incorporating a function to describe lagged effects up
to a month following exposure. Based on this model, what does the association
between temperature and mortality look like at lag 0 days? How about at lag 21 days?
What does the pattern of lagged effects look like when comparing the relative risk of
mortality at a hot temperature (e.g., 28 degrees C) to a milder temperature
(7 degrees C)? What about when comparing mortality at a cold temperature
(e.g., -4 degrees C) to a milder temperature (7 degrees C)? If you use a constant
term for the effect of exposure
over a month as opposed to the smooth function you just used, how does the overall
cumulative RR compare?</strong></li>
</ol>
<p>To extend the model to include temperature using a non-linear function, we’ll go back
to the <code>crossbasis</code> call, but this time we’ll make some changes to the exposure variable
dimension. The basis function for the exposure is set using the <code>argvar</code> (“var” is
for “variable”) parameter. Again, this allows us to include a list of parameters that
will be passed to <code>onebasis</code> to build a basis function and set up basis variables for
this dimension of the crossbasis. We can use a spline for temperature by specifying
<code>fun = "ns"</code>, as well as specify the degrees of freedom for that spline (here, I’ve used
4, but again, feel free to experiment):</p>
<div class="sourceCode" id="cb167"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb167-1"><a href="generalized-linear-models.html#cb167-1"></a>dl_basis_<span class="dv">4</span> &lt;-<span class="st"> </span><span class="kw">crossbasis</span>(obs<span class="op">$</span>tmean, <span class="dt">lag =</span> <span class="dv">30</span>,</span>
<span id="cb167-2"><a href="generalized-linear-models.html#cb167-2"></a>                       <span class="dt">argvar =</span> <span class="kw">list</span>(<span class="dt">fun =</span> <span class="st">&quot;ns&quot;</span>, <span class="dt">df =</span> <span class="dv">4</span>), </span>
<span id="cb167-3"><a href="generalized-linear-models.html#cb167-3"></a>                       <span class="dt">arglag =</span> <span class="kw">list</span>(<span class="dt">fun =</span> <span class="st">&quot;ns&quot;</span>, <span class="dt">df =</span> <span class="dv">6</span>))</span></code></pre></div>
<p>Try looking at the crossbasis from this function (you’ll need to look past the 30th row
or so, since the earliest rows will all be missing since they’re in that range where
they don’t have lag data available for the exposure). You can see that we now have a
<em>lot</em> of columns: specifically, we have 4 (degrees of freedom for the temperature spline)
times 6 (degrees of freedom for the lag spline) = 24 columns.</p>
<div class="sourceCode" id="cb168"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb168-1"><a href="generalized-linear-models.html#cb168-1"></a>dl_basis_<span class="dv">4</span> <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb168-2"><a href="generalized-linear-models.html#cb168-2"></a><span class="st">  </span><span class="kw">as.data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb168-3"><a href="generalized-linear-models.html#cb168-3"></a><span class="st">  </span><span class="kw">slice</span>(<span class="dv">28</span><span class="op">:</span><span class="dv">38</span>)</span></code></pre></div>
<pre><code>##       v1.l1    v1.l2    v1.l3    v1.l4    v1.l5       v1.l6      v2.l1
## 1        NA       NA       NA       NA       NA          NA         NA
## 2        NA       NA       NA       NA       NA          NA         NA
## 3        NA       NA       NA       NA       NA          NA         NA
## 4  2.068939 3.299498 3.111270 1.738184 2.541810 -0.51512317 -0.5552531
## 5  1.955177 3.314862 3.125558 1.820183 2.690445 -0.40693744 -0.5967078
## 6  1.886111 3.299149 3.148516 1.893007 2.766242 -0.32385143 -0.6273517
## 7  1.882405 3.248469 3.180797 1.927784 2.804239 -0.08305771 -0.6419354
## 8  1.852973 3.165440 3.220817 1.900001 2.905860  0.08447527 -0.6588751
## 9  1.757370 3.058913 3.263914 1.795344 3.175517  0.03686863 -0.7106452
## 10 1.760596 2.944202 3.299498 1.779203 3.259667 -0.16712630 -0.7084665
## 11 1.797646 2.838520 3.314862 1.698607 3.497240 -0.17786583 -0.7118631
##         v2.l2      v2.l3      v2.l4      v2.l5         v2.l6    v3.l1    v3.l2
## 1          NA         NA         NA         NA            NA       NA       NA
## 2          NA         NA         NA         NA            NA       NA       NA
## 3          NA         NA         NA         NA            NA       NA       NA
## 4  -0.7011824 -0.7707934 -0.4847858 -0.9916438 -0.0956588789 1.405249 1.838701
## 5  -0.6979016 -0.7603742 -0.4547662 -0.9667940 -0.0791413415 1.478133 1.830775
## 6  -0.7047091 -0.7492423 -0.4287099 -0.9503322 -0.0554076103 1.526744 1.841501
## 7  -0.7234011 -0.7371123 -0.4081381 -0.9450033 -0.0058689802 1.541114 1.873929
## 8  -0.7537142 -0.7241504 -0.4035141 -0.9205842  0.0358717107 1.565836 1.927170
## 9  -0.7930344 -0.7111578 -0.4381402 -0.7997450 -0.0007806944 1.643309 1.996194
## 10 -0.8364025 -0.7011824 -0.4373333 -0.7657041 -0.0621066847 1.644968 2.071685
## 11 -0.8780716 -0.6979016 -0.4735973 -0.6384769 -0.0958995727 1.631672 2.143093
##       v3.l3    v3.l4    v3.l5       v3.l6      v4.l1     v4.l2     v4.l3
## 1        NA       NA       NA          NA         NA        NA        NA
## 2        NA       NA       NA          NA         NA        NA        NA
## 3        NA       NA       NA          NA         NA        NA        NA
## 4  1.955381 1.180876 2.353392  0.20605400 -0.8041945 -1.052250 -1.119024
## 5  1.942554 1.126503 2.294679  0.17194514 -0.8459049 -1.047714 -1.111683
## 6  1.926528 1.081359 2.257968  0.12135036 -0.8737239 -1.053852 -1.102512
## 7  1.906672 1.048474 2.249542  0.01133949 -0.8819473 -1.072411 -1.091149
## 8  1.883354 1.051489 2.198457 -0.07875894 -0.8960954 -1.102879 -1.077804
## 9  1.858659 1.116576 2.004017 -0.03652356 -0.9404317 -1.142380 -1.063672
## 10 1.838701 1.121782 1.943746  0.09297047 -0.9413808 -1.185582 -1.052250
## 11 1.830775 1.177720 1.763872  0.11448195 -0.9337721 -1.226447 -1.047714
##         v4.l4     v4.l5        v4.l6
## 1          NA        NA           NA
## 2          NA        NA           NA
## 3          NA        NA           NA
## 4  -0.6757908 -1.346797 -0.117920408
## 5  -0.6446743 -1.313197 -0.098400617
## 6  -0.6188389 -1.292188 -0.069446282
## 7  -0.6000200 -1.287366 -0.006489356
## 8  -0.6017453 -1.258131  0.045072099
## 9  -0.6389933 -1.146857  0.020901671
## 10 -0.6419722 -1.112366 -0.053205061
## 11 -0.6739847 -1.009427 -0.065515636</code></pre>
<p>The <code>dlnm</code> package has done
the work of setting up this crossbasis function, as well as creating this matrix of
basis variables from our original simple column of temperature measurements. This
is getting to be a much more complex function than the simple linear/unconstrained lag
function that we started with. However, the underlying principles and mechanics are the
same, they’re just scaling up to allow some more complex “shapes” in our exposure-response
association.</p>
<p>We can add this new crossbasis function to the regression model, and then predict from
the crossbasis and regression model to get a view of how temperature is (non-linearly) associated
with mortality risk at different lags, comparing to a baseline temperature of 7 degrees C:</p>
<div class="sourceCode" id="cb170"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb170-1"><a href="generalized-linear-models.html#cb170-1"></a>dist_lag_mod_<span class="dv">5</span> &lt;-<span class="st"> </span><span class="kw">glm</span>(all <span class="op">~</span><span class="st"> </span>dl_basis_<span class="dv">4</span> <span class="op">+</span><span class="st"> </span></span>
<span id="cb170-2"><a href="generalized-linear-models.html#cb170-2"></a><span class="st">                        </span><span class="kw">factor</span>(dow, <span class="dt">ordered =</span> <span class="ot">FALSE</span>) <span class="op">+</span></span>
<span id="cb170-3"><a href="generalized-linear-models.html#cb170-3"></a><span class="st">                          </span><span class="kw">ns</span>(time, <span class="dt">df =</span> <span class="dv">158</span>), </span>
<span id="cb170-4"><a href="generalized-linear-models.html#cb170-4"></a>                        <span class="dt">data =</span> obs, <span class="dt">family =</span> <span class="st">&quot;quasipoisson&quot;</span>)</span>
<span id="cb170-5"><a href="generalized-linear-models.html#cb170-5"></a></span>
<span id="cb170-6"><a href="generalized-linear-models.html#cb170-6"></a>cp_dl &lt;-<span class="st"> </span><span class="kw">crosspred</span>(dl_basis_<span class="dv">4</span>, dist_lag_mod_<span class="dv">5</span>, <span class="dt">cen =</span> <span class="dv">7</span>, <span class="dt">bylag =</span> <span class="dv">1</span>)</span></code></pre></div>
<p>The object created by <code>crosspred</code> includes a <em>lot</em> of output (you can check out the
whole thing by running <code>cp_dl</code> to print it out). We can extract elements from this object
(for example, if we want to get effect estimates or estimates of confidence intervals).
We can also create a variety of plots from this object. The following plots all use the
<code>plot</code> method for <code>crosspred</code> objects, so you can access the helpfile with <code>?plot.crosspred</code>.</p>
<p>First, we can look at “slices,” where we focus on just one lag value and look at the non-linear relationship between temperature and mortality risk at that lag only. For example, here are plots showing the relationship between temperature and mortality risk on the same day of exposure (lag 0) and 21 days after exposure (lag 21):</p>
<div class="sourceCode" id="cb171"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb171-1"><a href="generalized-linear-models.html#cb171-1"></a><span class="kw">plot</span>(cp_dl, <span class="dt">ptype =</span> <span class="st">&quot;slices&quot;</span>, <span class="dt">lag =</span> <span class="dv">0</span>)</span></code></pre></div>
<p><img src="adv_epi_analysis_files/figure-html/unnamed-chunk-105-1.png" width="672" /></p>
<div class="sourceCode" id="cb172"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb172-1"><a href="generalized-linear-models.html#cb172-1"></a><span class="kw">plot</span>(cp_dl, <span class="dt">ptype =</span> <span class="st">&quot;slices&quot;</span>, <span class="dt">lag =</span> <span class="dv">21</span>)</span></code></pre></div>
<p><img src="adv_epi_analysis_files/figure-html/unnamed-chunk-105-2.png" width="672" /></p>
<p>You can see that heat has a stronger relationship with mortality risk than cold at lag 0,
while at a longer lag, there continues to be a positive association between cold temperature
and mortality risk, but now the relationship with heat has shifted to be negative.</p>
<p>You can do the same idea of looking at a “slice” for a specific temperature, in this case
seeing how effects vary across lags when comparing that temperature to the baseline temperature
(7 degrees C, which we set when we ran <code>crosspred</code>). For example, here are “slices” for
28 degrees C and -4 degrees C:</p>
<div class="sourceCode" id="cb173"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb173-1"><a href="generalized-linear-models.html#cb173-1"></a><span class="kw">plot</span>(cp_dl, <span class="dt">ptype =</span> <span class="st">&quot;slices&quot;</span>, <span class="dt">var =</span> <span class="dv">28</span>)</span></code></pre></div>
<p><img src="adv_epi_analysis_files/figure-html/unnamed-chunk-106-1.png" width="672" /></p>
<div class="sourceCode" id="cb174"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb174-1"><a href="generalized-linear-models.html#cb174-1"></a><span class="kw">plot</span>(cp_dl, <span class="dt">ptype =</span> <span class="st">&quot;slices&quot;</span>, <span class="dt">var =</span> <span class="dv">-4</span>)</span></code></pre></div>
<p><img src="adv_epi_analysis_files/figure-html/unnamed-chunk-106-2.png" width="672" />
These plots again reinforce that heat’s association with mortality risk is more immediate,
while cold has an association that plays out over a much longer lag following exposure.</p>
<p>There are also some plots you can make from the <code>crosspred</code> object that help show the full,
three-dimensional association between the exposure, lag time, and risk of the outcome.
For example, the default plot created from the <code>crosspred</code> object is a three-dimensional
plot (the <code>theta</code>, <code>phi</code>, and <code>lphi</code> parameters shift the angle we view it from), while
the “contour” plot type shows us a contour plot of these results (in other words, showing
the exposure and lag variables in two dimensions of a two-dimensional plot then showing
relative risk using color for each combination). You can think of the ‘sliced’ plots from above as two-dimensional slices of the three-dimensional graph if we slice right at the selected <code>lag</code> or <code>var</code> value. Here is the code to create those plots:</p>
<div class="sourceCode" id="cb175"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb175-1"><a href="generalized-linear-models.html#cb175-1"></a><span class="kw">plot</span>(cp_dl, <span class="dt">theta =</span> <span class="dv">200</span>, <span class="dt">phi =</span> <span class="dv">40</span>, <span class="dt">lphi =</span> <span class="dv">30</span>)</span></code></pre></div>
<p><img src="adv_epi_analysis_files/figure-html/unnamed-chunk-107-1.png" width="672" /></p>
<div class="sourceCode" id="cb176"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb176-1"><a href="generalized-linear-models.html#cb176-1"></a><span class="kw">plot</span>(cp_dl, <span class="dt">ptype =</span> <span class="st">&quot;contour&quot;</span>)</span></code></pre></div>
<p><img src="adv_epi_analysis_files/figure-html/unnamed-chunk-107-2.png" width="672" /></p>
<p>To see how a ‘constant’ lag-response model compares to the smooth function from this model we have to go back to the <code>crossbasis</code> and use the appropriate argument in the <code>arglag</code> parameter:</p>
<div class="sourceCode" id="cb177"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb177-1"><a href="generalized-linear-models.html#cb177-1"></a>dl_basis_<span class="dv">5</span> &lt;-<span class="st"> </span><span class="kw">crossbasis</span>(obs<span class="op">$</span>tmean, <span class="dt">lag =</span> <span class="dv">30</span>,</span>
<span id="cb177-2"><a href="generalized-linear-models.html#cb177-2"></a>                       <span class="dt">argvar =</span> <span class="kw">list</span>(<span class="dt">fun =</span> <span class="st">&quot;ns&quot;</span>, <span class="dt">df =</span> <span class="dv">4</span>), </span>
<span id="cb177-3"><a href="generalized-linear-models.html#cb177-3"></a>                       <span class="dt">arglag =</span> <span class="kw">list</span>(<span class="dt">fun =</span> <span class="st">&quot;strata&quot;</span>, <span class="dt">df =</span> <span class="dv">1</span>))</span></code></pre></div>
<p>The function <code>strata</code> in <code>arglag</code> essentially breaks up the lag window into strata equaling the degrees of freedom specified, and the lag-response is assumed to be constant for each day within each stratum. Here we specified <code>df=1</code> so the lag-response is assumed to be constant for the entire lag window. In other words, the exposure in each day in the lag window is constrained to have the same effect. If we look at the <code>crossbasis</code> from this function you’ll see that we have far fewer columns. Remember that the total number of columns is determined by the total number of degrees of freedom, which is the product of the df’s in each of <code>argvar</code> and <code>arglag</code> so in this case 4.</p>
<div class="sourceCode" id="cb178"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb178-1"><a href="generalized-linear-models.html#cb178-1"></a>dl_basis_<span class="dv">5</span> <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb178-2"><a href="generalized-linear-models.html#cb178-2"></a><span class="st">  </span><span class="kw">as.data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb178-3"><a href="generalized-linear-models.html#cb178-3"></a><span class="st">  </span><span class="kw">slice</span>(<span class="dv">28</span><span class="op">:</span><span class="dv">38</span>)</span></code></pre></div>
<pre><code>##       v1.l1     v2.l1     v3.l1     v4.l1
## 1        NA        NA        NA        NA
## 2        NA        NA        NA        NA
## 3        NA        NA        NA        NA
## 4  14.69900 -4.438015 10.919532 -6.249020
## 5  15.03355 -4.382485 10.789984 -6.174883
## 6  15.21075 -4.347038 10.707109 -6.127455
## 7  15.33913 -4.332385 10.672850 -6.107850
## 8  15.51220 -4.298983 10.594759 -6.063160
## 9  15.89771 -4.127076 10.317738 -5.904626
## 10 15.96057 -4.094014 10.267995 -5.876159
## 11 16.37863 -3.880472  9.958228 -5.698886</code></pre>
<p>We can now run the same model as above replacing the <code>crossbasis</code> with the one we just created and
repeat the prediction to see how the temperature effect comparing to a baseline temperature
of 7 degrees C changes when we constrain the lag-response to be constant.</p>
<div class="sourceCode" id="cb180"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb180-1"><a href="generalized-linear-models.html#cb180-1"></a>dist_lag_mod_<span class="dv">6</span> &lt;-<span class="st"> </span><span class="kw">glm</span>(all <span class="op">~</span><span class="st"> </span>dl_basis_<span class="dv">5</span> <span class="op">+</span><span class="st"> </span></span>
<span id="cb180-2"><a href="generalized-linear-models.html#cb180-2"></a><span class="st">                        </span><span class="kw">factor</span>(dow, <span class="dt">ordered =</span> <span class="ot">FALSE</span>) <span class="op">+</span></span>
<span id="cb180-3"><a href="generalized-linear-models.html#cb180-3"></a><span class="st">                          </span><span class="kw">ns</span>(time, <span class="dt">df =</span> <span class="dv">158</span>), </span>
<span id="cb180-4"><a href="generalized-linear-models.html#cb180-4"></a>                        <span class="dt">data =</span> obs, <span class="dt">family =</span> <span class="st">&quot;quasipoisson&quot;</span>)</span>
<span id="cb180-5"><a href="generalized-linear-models.html#cb180-5"></a></span>
<span id="cb180-6"><a href="generalized-linear-models.html#cb180-6"></a>cp_dlconstant &lt;-<span class="st"> </span><span class="kw">crosspred</span>(dl_basis_<span class="dv">5</span>, dist_lag_mod_<span class="dv">6</span>, <span class="dt">cen =</span> <span class="dv">7</span>, <span class="dt">bylag =</span> <span class="dv">1</span>)</span></code></pre></div>
<p>If we look at the same plots and sliced plots as above we can see that this is a much simple model.</p>
<div class="sourceCode" id="cb181"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb181-1"><a href="generalized-linear-models.html#cb181-1"></a><span class="kw">plot</span>(cp_dlconstant, <span class="dt">ptype =</span> <span class="st">&quot;slices&quot;</span>, <span class="dt">lag =</span> <span class="dv">0</span>)</span>
<span id="cb181-2"><a href="generalized-linear-models.html#cb181-2"></a><span class="kw">plot</span>(cp_dlconstant, <span class="dt">ptype =</span> <span class="st">&quot;slices&quot;</span>, <span class="dt">lag =</span> <span class="dv">21</span>)</span></code></pre></div>
<p><img src="adv_epi_analysis_files/figure-html/unnamed-chunk-111-1.png" width="672" /></p>
<p>The two plots are identical (because we assume that the exposure-response is the same at all lags) with colder temperatures having a negative effect, while the warmer temperatures appear to be protective.</p>
<div class="sourceCode" id="cb182"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb182-1"><a href="generalized-linear-models.html#cb182-1"></a><span class="kw">plot</span>(cp_dlconstant, <span class="dt">ptype =</span> <span class="st">&quot;slices&quot;</span>, <span class="dt">var =</span> <span class="dv">28</span>)</span></code></pre></div>
<p><img src="adv_epi_analysis_files/figure-html/unnamed-chunk-112-1.png" width="672" /></p>
<div class="sourceCode" id="cb183"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb183-1"><a href="generalized-linear-models.html#cb183-1"></a><span class="kw">plot</span>(cp_dlconstant, <span class="dt">ptype =</span> <span class="st">&quot;slices&quot;</span>, <span class="dt">var =</span> <span class="dv">-4</span>)</span></code></pre></div>
<p><img src="adv_epi_analysis_files/figure-html/unnamed-chunk-112-2.png" width="672" /></p>
<p>Here we see the constant lag-response more clearly, but at different effects depending on the set temperature. The hot temperature appears to be mildly protective (RR &lt; 1.0), while the cold temperature is harmful (RR &gt; 1.0).</p>
<p>The reduced complexity is evident in the 3-d plot (which looks “flat” on one of the dimensions) and the contour plot (which has large rectangular areas) as well.</p>
<div class="sourceCode" id="cb184"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb184-1"><a href="generalized-linear-models.html#cb184-1"></a><span class="kw">plot</span>(cp_dlconstant, <span class="dt">theta =</span> <span class="dv">200</span>, <span class="dt">phi =</span> <span class="dv">40</span>, <span class="dt">lphi =</span> <span class="dv">30</span>)</span></code></pre></div>
<p><img src="adv_epi_analysis_files/figure-html/unnamed-chunk-113-1.png" width="672" /></p>
<div class="sourceCode" id="cb185"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb185-1"><a href="generalized-linear-models.html#cb185-1"></a><span class="kw">plot</span>(cp_dlconstant, <span class="dt">ptype =</span> <span class="st">&quot;contour&quot;</span>)</span></code></pre></div>
<p><img src="adv_epi_analysis_files/figure-html/unnamed-chunk-113-2.png" width="672" /></p>
<p>One other thing that we can do with the model output is we can estimate the cumulative risk
across lags, for example for a month of hot temperature (28 degrees C) compared to cooler temperature (7 degrees C). We do this by essentially accumulating the RRs from each lag-day as follows. The crosspred object has estimates of the coefficients for each lag day (in the
<code>matfit</code> element), and you
could add these up yourself, or you can extract a difference element (<code>allfit</code>) that has
already added these up for you to get a cumulative effect estimate. If you’d like to
calculate confidence intervals, you can get an estimate of the standard error for this
cumulative estimate with the <code>allse</code> element of the crosspred object. We can get all these
for a temperature of 28 degrees C; since we set the crosspred object to be centered at
7 degrees C, this will allow us to compare 28 to 7 degrees C:</p>
<div class="sourceCode" id="cb186"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb186-1"><a href="generalized-linear-models.html#cb186-1"></a><span class="co">### parameter for each lag-day</span></span>
<span id="cb186-2"><a href="generalized-linear-models.html#cb186-2"></a>cp_dlconstant<span class="op">$</span>matfit[cp_dlconstant<span class="op">$</span>predvar<span class="op">==</span><span class="dv">28</span>]</span></code></pre></div>
<pre><code>##  [1] -0.004774825 -0.004774825 -0.004774825 -0.004774825 -0.004774825
##  [6] -0.004774825 -0.004774825 -0.004774825 -0.004774825 -0.004774825
## [11] -0.004774825 -0.004774825 -0.004774825 -0.004774825 -0.004774825
## [16] -0.004774825 -0.004774825 -0.004774825 -0.004774825 -0.004774825
## [21] -0.004774825 -0.004774825 -0.004774825 -0.004774825 -0.004774825
## [26] -0.004774825 -0.004774825 -0.004774825 -0.004774825 -0.004774825
## [31] -0.004774825</code></pre>
<div class="sourceCode" id="cb188"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb188-1"><a href="generalized-linear-models.html#cb188-1"></a><span class="co">### combined model parameter for the cumulative RR (this is the sum for all of the above parameters)</span></span>
<span id="cb188-2"><a href="generalized-linear-models.html#cb188-2"></a>cp_dlconstant<span class="op">$</span>allfit[cp_dlconstant<span class="op">$</span>predvar<span class="op">==</span><span class="dv">28</span>]</span></code></pre></div>
<pre><code>##         28 
## -0.1480196</code></pre>
<div class="sourceCode" id="cb190"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb190-1"><a href="generalized-linear-models.html#cb190-1"></a><span class="co">### corresponding standard error for the cumulative RR parameter</span></span>
<span id="cb190-2"><a href="generalized-linear-models.html#cb190-2"></a>cp_dlconstant<span class="op">$</span>allse[cp_dlconstant<span class="op">$</span>predvar<span class="op">==</span><span class="dv">28</span>]</span></code></pre></div>
<pre><code>##         28 
## 0.05128501</code></pre>
<p>If we exponentiate the model parameter we will get the cumulative RR estimate and likewise using the model parameter and standard error we can derive 95% Confidence Intervals (CIs) for the cumulative RR. For the central estimate:</p>
<p><span class="math display">\[
RR=exp(\beta)=exp(-0.148)=0.86
\]</span>
For the confidence interval:</p>
<p><span class="math display">\[
exp(\beta \pm 1.96*se) = exp(-0.148 \pm 1.96*0.05) = (0.78, 0.95)
\]</span></p>
<p>The <code>crosspred</code> object, it turns out, stores this information as well (in the <code>allRRfit</code>, <code>allRRlow</code>, and <code>allRRhigh</code> elements), so we can extract these elements directly without doing the math:</p>
<div class="sourceCode" id="cb192"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb192-1"><a href="generalized-linear-models.html#cb192-1"></a>cp_dlconstant<span class="op">$</span>allRRfit[cp_dlconstant<span class="op">$</span>predvar<span class="op">==</span><span class="dv">28</span>]</span></code></pre></div>
<pre><code>##        28 
## 0.8624142</code></pre>
<div class="sourceCode" id="cb194"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb194-1"><a href="generalized-linear-models.html#cb194-1"></a>cp_dlconstant<span class="op">$</span>allRRlow[cp_dlconstant<span class="op">$</span>predvar<span class="op">==</span><span class="dv">28</span>]</span></code></pre></div>
<pre><code>##        28 
## 0.7799415</code></pre>
<div class="sourceCode" id="cb196"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb196-1"><a href="generalized-linear-models.html#cb196-1"></a>cp_dlconstant<span class="op">$</span>allRRhigh[cp_dlconstant<span class="op">$</span>predvar<span class="op">==</span><span class="dv">28</span>]</span></code></pre></div>
<pre><code>##        28 
## 0.9536078</code></pre>
<p>Does this look accurate? Do we expect a 14% decrease in mortality comparing a very hot month to a cool month?</p>
<p>Now let’s calculate the cumulative RR for temperature at 28 degrees for the smooth lag-response function model from before (i.e., pull those same elements from the model we fit before
with a smoother lag-response function):</p>
<div class="sourceCode" id="cb198"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb198-1"><a href="generalized-linear-models.html#cb198-1"></a>cp_dl<span class="op">$</span>allRRfit[cp_dl<span class="op">$</span>predvar<span class="op">==</span><span class="dv">28</span>]</span></code></pre></div>
<pre><code>##       28 
## 1.078548</code></pre>
<div class="sourceCode" id="cb200"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb200-1"><a href="generalized-linear-models.html#cb200-1"></a>cp_dl<span class="op">$</span>allRRlow[cp_dl<span class="op">$</span>predvar<span class="op">==</span><span class="dv">28</span>]</span></code></pre></div>
<pre><code>##        28 
## 0.9768645</code></pre>
<div class="sourceCode" id="cb202"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb202-1"><a href="generalized-linear-models.html#cb202-1"></a>cp_dl<span class="op">$</span>allRRhigh[cp_dl<span class="op">$</span>predvar<span class="op">==</span><span class="dv">28</span>]</span></code></pre></div>
<pre><code>##       28 
## 1.190816</code></pre>
<p>Based on this model, we infer there’s about a 6% cumulative increase associated with a
temperature of 28 degrees C compared to 7 degrees.</p>
<p>Does this look more accurate? Which of the two lag-response functions is more likely to be true?</p>
<ol start="4" style="list-style-type: decimal">
<li><strong>Assume that we are interested in the potential effect of a 5-day
heatwave occurring on lags 0 to 4? You can assess this as the effect of hot temperature
(e.g., 28 degrees C) during these lags, while the temperature remains warm but more
mild (e.g., 20 degrees C) the rest of the month, against constant 20 degrees C for
the whole month. What is the effect under the ‘constant’ model? How about the smooth
function lag model?</strong></li>
</ol>
<p>Using the <code>crosspred</code> function we can compare any exposure history over a lag-window of interest to a reference value (or values varying over time in the same window). Realistically, a whole month of extremely high exposures is unlikely. Extreme phenomena (such as 28 degree mean daily temperature in London) are more likely to last a shorter period of time. Furthermore, the effect of an event like a heat wave (likely occurring in the summer) is probably better assessed with a referent value more akin to what the heat wave is replacing, i.e., a warm but more mild summer temperature rather than temperatures more likely to occur in other seasons. We saw above that the effect of hot temperatures tends to be more short term, so let’s assess the potential effect of a 5-day heatwave assessed on the last day of the heatwave. The rest of the days in the month are at 20 degrees C and we will use the same value as the referent value for the whole month. Realistically there will be variability in the temperatures during these days as well, but for the purposes of this exercise let’s keep it constant at 20 for simplicity. Let’s assess this effect using the constant lag-response model.</p>
<div class="sourceCode" id="cb204"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb204-1"><a href="generalized-linear-models.html#cb204-1"></a>hw_constant &lt;-<span class="st"> </span><span class="kw">crosspred</span>(dl_basis_<span class="dv">5</span>, dist_lag_mod_<span class="dv">6</span>, </span>
<span id="cb204-2"><a href="generalized-linear-models.html#cb204-2"></a>                         <span class="dt">at =</span> <span class="kw">exphist</span>(<span class="kw">c</span>(<span class="kw">rep</span>(<span class="dv">20</span>, <span class="dv">26</span>), <span class="kw">rep</span>(<span class="dv">28</span>, <span class="dv">5</span>)), <span class="dt">times =</span> <span class="dv">31</span>, <span class="dt">lag =</span> <span class="dv">30</span>) , </span>
<span id="cb204-3"><a href="generalized-linear-models.html#cb204-3"></a>                         <span class="dt">cen =</span> <span class="dv">20</span>, <span class="dt">bylag =</span> <span class="dv">1</span>)</span></code></pre></div>
<p>The <code>exphist</code> function allows us to designate distinct exposure values for the entire lag-window. The exposure values here appear in an oldest (lag30) to most recent (lag0) order. The <code>times</code> argument determines were the list of exposure begins in the lag window (here <code>time = 31</code> or lag30 from 0-30). The effect estimate and corresponding CI can be extracted as above.</p>
<div class="sourceCode" id="cb205"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb205-1"><a href="generalized-linear-models.html#cb205-1"></a>hw_constant<span class="op">$</span>allRRfit</span></code></pre></div>
<pre><code>##       31 
## 1.004005</code></pre>
<div class="sourceCode" id="cb207"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb207-1"><a href="generalized-linear-models.html#cb207-1"></a>hw_constant<span class="op">$</span>allRRlow</span></code></pre></div>
<pre><code>##        31 
## 0.9891951</code></pre>
<div class="sourceCode" id="cb209"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb209-1"><a href="generalized-linear-models.html#cb209-1"></a>hw_constant<span class="op">$</span>allRRhigh</span></code></pre></div>
<pre><code>##       31 
## 1.019037</code></pre>
<p>Now, lets repeat this with the smooth function lag-response model:</p>
<div class="sourceCode" id="cb211"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb211-1"><a href="generalized-linear-models.html#cb211-1"></a>hw_smooth&lt;-<span class="kw">crosspred</span>(dl_basis_<span class="dv">4</span>, dist_lag_mod_<span class="dv">5</span>, </span>
<span id="cb211-2"><a href="generalized-linear-models.html#cb211-2"></a>                     <span class="dt">at =</span> <span class="kw">exphist</span>(<span class="kw">c</span>(<span class="kw">rep</span>(<span class="dv">20</span>, <span class="dv">26</span>), <span class="kw">rep</span>(<span class="dv">28</span>, <span class="dv">5</span>)), <span class="dt">times =</span> <span class="dv">31</span>, <span class="dt">lag =</span> <span class="dv">30</span>) , </span>
<span id="cb211-3"><a href="generalized-linear-models.html#cb211-3"></a>                     <span class="dt">cen =</span> <span class="dv">20</span>, <span class="dt">bylag =</span> <span class="dv">1</span>)</span>
<span id="cb211-4"><a href="generalized-linear-models.html#cb211-4"></a></span>
<span id="cb211-5"><a href="generalized-linear-models.html#cb211-5"></a>hw_smooth<span class="op">$</span>allRRfit</span></code></pre></div>
<pre><code>##       31 
## 1.402728</code></pre>
<div class="sourceCode" id="cb213"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb213-1"><a href="generalized-linear-models.html#cb213-1"></a>hw_smooth<span class="op">$</span>allRRlow</span></code></pre></div>
<pre><code>##       31 
## 1.356389</code></pre>
<div class="sourceCode" id="cb215"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb215-1"><a href="generalized-linear-models.html#cb215-1"></a>hw_smooth<span class="op">$</span>allRRhigh</span></code></pre></div>
<pre><code>##       31 
## 1.450651</code></pre>
<p>We see that the constant lag-response model underestimates the RR and does not capture any potential effect of a heatwave, while the smooth term lag-response model indicates that there is a 40% increase in mortality for the last day of the heatwave. Note that this increase in mortality is not the only effect, as based on out model the heatwave started having an effect on the same day it started, i.e. we would expect all 5 heatwave days to have a temperature related increase in mortality compared to the days before the heat-wave. We can look at the increase in mortality for each day if we look at the individual effect estimates:</p>
<div class="sourceCode" id="cb217"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb217-1"><a href="generalized-linear-models.html#cb217-1"></a><span class="co">### individual lag-day parameters</span></span>
<span id="cb217-2"><a href="generalized-linear-models.html#cb217-2"></a>hw_smooth<span class="op">$</span>matfit</span></code></pre></div>
<pre><code>##         lag0       lag1       lag2       lag3       lag4 lag5 lag6 lag7 lag8
## 31 0.1196662 0.09213574 0.06563143 0.04117951 0.01980617    0    0    0    0
##    lag9 lag10 lag11 lag12 lag13 lag14 lag15 lag16 lag17 lag18 lag19 lag20 lag21
## 31    0     0     0     0     0     0     0     0     0     0     0     0     0
##    lag22 lag23 lag24 lag25 lag26 lag27 lag28 lag29 lag30
## 31     0     0     0     0     0     0     0     0     0</code></pre>
<div class="sourceCode" id="cb219"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb219-1"><a href="generalized-linear-models.html#cb219-1"></a><span class="co">#### individual lag-day RRs</span></span>
<span id="cb219-2"><a href="generalized-linear-models.html#cb219-2"></a>hw_smooth<span class="op">$</span>matRRfit</span></code></pre></div>
<pre><code>##        lag0     lag1     lag2     lag3     lag4 lag5 lag6 lag7 lag8 lag9 lag10
## 31 1.127121 1.096514 1.067833 1.042039 1.020004    1    1    1    1    1     1
##    lag11 lag12 lag13 lag14 lag15 lag16 lag17 lag18 lag19 lag20 lag21 lag22
## 31     1     1     1     1     1     1     1     1     1     1     1     1
##    lag23 lag24 lag25 lag26 lag27 lag28 lag29 lag30
## 31     1     1     1     1     1     1     1     1</code></pre>
<p>The first day of the heatwave will have an effect corresponding to a lag0 effect:</p>
<p><span class="math display">\[
RR=exp(0.107)=1.11
\]</span></p>
<p>The second day of the heatwave will have an effect corresponding to a lag0 and lag1 effect:</p>
<p><span class="math display">\[
RR = exp(0.107 + 0.085) = 1.21
\]</span></p>
<p>(This quantity is also equal to the product of the lag-day specific RRs for lag0 and lag1:)</p>
<p><span class="math display">\[
1.11 \times 1.09 = 1.21
\]</span></p>
<p>And so on, until we reach our last day of the heatwave with RR=1.39. There is a bidirectional relationship for this RR, as you can interpret this as the overall effect of the heatwave on mortality on the last day of the heatwave, or as the overall effect of temperature on the first day of the heatwave on mortality over the next 5 days.</p>

</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-armstrong2006models">
<p>Armstrong, Ben. 2006. “Models for the Relationship Between Ambient Temperature and Daily Mortality.” <em>Epidemiology</em>, 624–31.</p>
</div>
<div id="ref-armstrong2014conditional">
<p>Armstrong, Ben G, Antonio Gasparrini, and Aurelio Tobias. 2014. “Conditional Poisson Models: A Flexible Alternative to Conditional Logistic Case Cross-over Analysis.” <em>BMC Medical Research Methodology</em> 14 (1): 122.</p>
</div>
<div id="ref-basu2005temperature">
<p>Basu, Rupa, Francesca Dominici, and Jonathan M Samet. 2005. “Temperature and Mortality Among the Elderly in the United States: A Comparison of Epidemiologic Methods.” <em>Epidemiology</em>, 58–66.</p>
</div>
<div id="ref-bhaskaran2013time">
<p>Bhaskaran, Krishnan, Antonio Gasparrini, Shakoor Hajat, Liam Smeeth, and Ben Armstrong. 2013. “Time Series Regression Studies in Environmental Epidemiology.” <em>International Journal of Epidemiology</em> 42 (4): 1187–95.</p>
</div>
<div id="ref-dunn2018generalized1">
<p>Dunn, Peter K, and Gordon K Smyth. 2018. “Statistical Models.” In <em>Generalized Linear Models with Examples in R</em>, 1–30. Springer.</p>
</div>
<div id="ref-gasparrini2014modeling">
<p>Gasparrini, Antonio. 2014. “Modeling Exposure–Lag–Response Associations with Distributed Lag Non-Linear Models.” <em>Statistics in Medicine</em> 33 (5): 881–99.</p>
</div>
<div id="ref-gasparrini2010time">
<p>Gasparrini, Antonio, and Ben Armstrong. 2010. “Time Series Analysis on the Health Effects of Temperature: Advancements and Limitations.” <em>Environmental Research</em> 110 (6): 633–38.</p>
</div>
<div id="ref-imai2015time">
<p>Imai, Chisato, Ben Armstrong, Zaid Chalabi, Punam Mangtani, and Masahiro Hashizume. 2015. “Time Series Regression Model for Infectious Disease and Weather.” <em>Environmental Research</em> 142: 319–27.</p>
</div>
<div id="ref-james2013introduction3">
<p>James, Gareth, Daniela Witten, Trevor Hastie, and Robert Tibshirani. 2013. “Linear Regression.” In <em>An Introduction to Statistical Learning: With Applications in R</em>, 59–126. Springer.</p>
</div>
<div id="ref-lu2007equivalence">
<p>Lu, Yun, and Scott L Zeger. 2007. “On the Equivalence of Case-Crossover and Time Series Methods in Environmental Epidemiology.” <em>Biostatistics</em> 8 (2): 337–44.</p>
</div>
<div id="ref-vicedo2019hands">
<p>Vicedo-Cabrera, Ana M, Francesco Sera, and Antonio Gasparrini. 2019. “Hands-on Tutorial on a Modeling Framework for Projections of Climate Change Impacts on Health.” <em>Epidemiology</em> 30 (3): 321–29.</p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="time-series-case-crossover-studies.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="natural-experiments.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["adv_epi_analysis.pdf", "adv_epi_analysis.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
